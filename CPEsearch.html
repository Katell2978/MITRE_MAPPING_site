<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Recherche CVE par CPE ‚Äì Page d√©di√©e</title>

<style>
:root{
  --bg:#0b1020; --card:#121a33; --txt:#e9ecff; --muted:#aab3da;
  --accent:#7aa2ff; --ok:#36d399; --warn:#fbbf24; --bad:#f87171; --line:#26325f;
  --mono: ui-monospace, Menlo, Consolas, monospace;
  --sans: system-ui, Segoe UI, Roboto, Arial, sans-serif;
}
body{margin:0;font-family:var(--sans);background:linear-gradient(160deg,#070a15,var(--bg));color:var(--txt);}  
header,main,.monitor{max-width:1100px;margin:auto;padding:18px}
h1{margin:0 0 8px;font-size:22px}
.card{background:rgba(18,26,51,.95);border:1px solid var(--line);border-radius:14px;padding:14px;margin-top:14px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
input,button{padding:10px;border-radius:10px;border:1px solid var(--line);background:#0a0f22;color:var(--txt)}
button{cursor:pointer}
button:hover{border-color:#3b4aa0}
.mono{font-family:var(--mono)}
.muted{color:var(--muted)}
.tag{border:1px solid var(--line);border-radius:999px;padding:2px 6px;font-size:11px;margin-left:6px;color:var(--muted)}
a{color:var(--accent);text-decoration:none}
a:hover{text-decoration:underline}
.hr{height:1px;background:var(--line);margin:12px 0}
.log{font-family:var(--mono);font-size:12px;max-height:200px;overflow:auto}
.log .ok{color:var(--ok)} .log .warn{color:var(--warn)} .log .bad{color:var(--bad)}
</style>
</head>

<body>
<header>
  <h1>Recherche de CVE √† partir d‚Äôun CPE</h1>
  <p class="muted">
    Page d√©di√©e √† l‚Äôexploration des vuln√©rabilit√©s (<b>CVE</b>) associ√©es √† un <b>CPE</b>.<br/>
    En cas de volume √©lev√©, les r√©sultats sont automatiquement limit√©s aux <b>12 derniers mois</b>.
  </p>
</header>

<main>
  <div class="card">
    <div class="row">
      <input id="cpeInput" class="mono" style="flex:1"
             placeholder="cpe:2.3:o:vendor:product:version:*:*:*:*:*:*:*" />
      <button id="searchBtn">Rechercher</button>
      <span id="status" class="muted">Pr√™t.</span>
    </div>
  </div>

  <div id="results"></div>
</main>

<div class="monitor">
  <div class="card">
    <b>Moniteur d‚Äôactivit√©</b>
    <div id="log" class="log"></div>
  </div>
</div>

<script>
const NVD_API = "https://services.nvd.nist.gov/rest/json/cves/2.0";
const CPE_THRESHOLD = 200;

function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g,c=>({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
  }[c]));
}
function log(msg,cls=""){
  const l=document.getElementById("log");
  l.innerHTML+=`<div class="${cls}">${escapeHtml(msg)}</div>`;
  l.scrollTop=l.scrollHeight;
}
function setStatus(t){document.getElementById("status").textContent=t}
function isLikelyCpe(x){return /^cpe:2\.3:/i.test(x)}
function last12Months(){
  const end=new Date();
  const start=new Date(); start.setMonth(start.getMonth()-12);
  const iso=d=>d.toISOString().split(".")[0]+"Z";
  return {start:iso(start), end:iso(end)};
}

async function searchCPE(cpe){
  if(!isLikelyCpe(cpe)){
    alert("CPE invalide (doit commencer par cpe:2.3:)");
    return;
  }

  setStatus("Recherche CPE‚Ä¶");
  log(`Recherche CPE: ${cpe}`);

  const probe=await fetch(`${NVD_API}?cpeName=${encodeURIComponent(cpe)}&resultsPerPage=1`).then(r=>r.json());
  const total=probe.totalResults||0;
  log(`Volume total NVD: ${total}`);

  let url, note="";
 if(total>CPE_THRESHOLD){
    const w=last12Months();
    note=" (12 derniers mois)";
    log(`Filtrage temporel appliqu√©: ${w.start} ‚Üí ${w.end}`,"warn");
    url=`${NVD_API}?cpeName=${encodeURIComponent(cpe)}&pubStartDate=${w.start}&pubEndDate=${w.end}&resultsPerPage=50`;
  } else {
    url=`${NVD_API}?cpeName=${encodeURIComponent(cpe)}&resultsPerPage=50`;
  }

  const json=await fetch(url).then(r=>r.json());
  renderResults(cpe+note, json);
  setStatus("R√©sultats affich√©s");
}

function renderResults(cpe, json){
  const vulns=json.vulnerabilities||[];
  const wrap=document.getElementById("results");

  if(!vulns.length){
    wrap.innerHTML=`<div class="card muted">Aucune CVE trouv√©e.</div>`;
    return;
  }

  wrap.innerHTML=`
  <div class="card">
    <h2>R√©sultats pour <span class="mono">${escapeHtml(cpe)}</span></h2>
    <div class="muted">${vulns.length} CVE affich√©es</div>
    <div class="hr"></div>
    <ul>
      ${vulns.map(v=>{
        const c=v.cve;
        const score=c.metrics?.cvssMetricV31?.[0]?.cvssData?.baseScore;
        const sev=c.metrics?.cvssMetricV31?.[0]?.cvssData?.baseSeverity;

        /* =====================================================
           LIEN VERS LA PAGE D‚ÄôANALYSE CVE COMPLETE
           üëâ MODIFIE CETTE URL POUR POINTER VERS TA PAGE CVE
           Exemple : analyse-cve.html?cve=CVE-2023-12345
           ===================================================== */
        const cveLink = `CVESearch.html?cve=${c.id}`;

        return `<li>
          <a href="${cveLink}"><b>${c.id}</b></a>
          ${score?`<span class="tag">CVSS ${score} ${sev}</span>`:""}
          <div class="muted">${escapeHtml(c.descriptions?.[0]?.value||"")}</div>
        </li>`;
      }).join("")}
    </ul>
  </div>`;
}

document.getElementById("searchBtn").onclick=()=>{
  const cpe=document.getElementById("cpeInput").value.trim();
  searchCPE(cpe);
};

log("Page charg√©e ‚úÖ");
</script>
</body>
</html>
