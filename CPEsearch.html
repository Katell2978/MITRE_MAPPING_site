<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Recherche CVE par CPE – Liste simple</title>
/*------------ DEBUT : GESTION DU CSS STYLE ------------------*/
<style>
:root{
  --bg:#0b1020; --card:#121a33; --txt:#e9ecff; --muted:#aab3da;
  --accent:#7aa2ff; --line:#26325f;
  --mono: ui-monospace, Menlo, Consolas, monospace;
  --sans: system-ui, Segoe UI, Roboto, Arial, sans-serif;
}
body{
  margin:0;
  font-family:var(--sans);
  background:linear-gradient(160deg,#070a15,var(--bg));
  color:var(--txt);
}
header,main{
  max-width:1100px;
  margin:auto;
  padding:18px;
}
h1{margin:0 0 8px;font-size:22px}
.card{
  background:rgba(18,26,51,.95);
  border:1px solid var(--line);
  border-radius:14px;
  padding:14px;
  margin-top:14px;
}
.row{display:flex;gap:10px;align-items:center}
input,button{
  padding:10px;
  border-radius:10px;
  border:1px solid var(--line);
  background:#0a0f22;
  color:var(--txt);
}
button{cursor:pointer}
button:hover{border-color:#3b4aa0}
.mono{font-family:var(--mono)}
.muted{color:var(--muted)}
ul{margin:8px 0 0 18px}
li{margin:6px 0}
.hr{height:1px;background:var(--line);margin:12px 0}
</style>
  /*------------ FIN : GESTION DU CSS STYLE ------------------*/
</head>

<body>

<header>
  <h1>Recherche de CVE à partir d’un CPE</h1>
  <p class="muted">
    Version <b>simple et stable</b> : CVE retournées par le NVD pour un CPE donné,<br/>
    triées du <b>plus récent au plus ancien</b> (date NVD).
  </p>
</header>

<main>
  <div class="card">
    <div class="row">
      <input id="cpeInput" class="mono" style="flex:1"
        placeholder="cpe:2.3:o:google:android:14.0:*:*:*:*:*:*:*" />
      <button id="searchBtn">Rechercher</button>
      <span id="status" class="muted">Prêt.</span>
    </div>
  </div>

  <div id="results"></div>
</main>

<script>
/* =====================
   CONFIG
   ===================== */
const NVD_API = "https://services.nvd.nist.gov/rest/json/cves/2.0";

/* =====================
   UTILS
   ===================== */
function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g,c=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}
function setStatus(t){
  document.getElementById("status").textContent = t;
}
function isLikelyCpe(x){
  return /^cpe:2\.3:/i.test(x);
}

/* =====================
   SEARCH CPE → CVE
   ===================== */
async function searchCPE(cpe){
  if(!isLikelyCpe(cpe)){
    alert("CPE invalide (doit commencer par cpe:2.3:)");
    return;
  }

  setStatus("Recherche en cours…");

  const url =
    `${NVD_API}?cpeName=${encodeURIComponent(cpe)}&resultsPerPage=150`;

  const json = await fetch(url).then(r => r.json());
  renderResults(cpe, json);

  setStatus("Résultats affichés");
}

/* =====================
   RENDER + TRI PAR DATE
   ===================== */
function renderResults(cpe, json){
  const vulns = json.vulnerabilities || [];
  const wrap = document.getElementById("results");

  if(!vulns.length){
    wrap.innerHTML =
      `<div class="card muted">Aucune CVE trouvée.</div>`;
    return;
  }

  // Tri du plus récent au plus ancien
  vulns.sort((a,b)=>{
    const da = new Date(a.cve.published || 0);
    const db = new Date(b.cve.published || 0);
    return db - da;
  });

  wrap.innerHTML = `
    <div class="card">
      <h2>Résultats pour <span class="mono">${escapeHtml(cpe)}</span></h2>
      <div class="muted">${vulns.length} CVE affichées</div>
      <div class="hr"></div>
      <ul>
        ${vulns.map(v=>{
          const c = v.cve;
          const date = c.published
            ? c.published.split("T")[0]
            : "n/a";
          return `
            <li>
              <b>${c.id}</b>
              <span class="muted">(${date})</span>
              <div class="muted">
                ${escapeHtml(c.descriptions?.[0]?.value || "")}
              </div>
            </li>`;
        }).join("")}
      </ul>
    </div>`;
}

/* =====================
   UI
   ===================== */
document.getElementById("searchBtn").onclick = ()=>{
  searchCPE(
    document.getElementById("cpeInput").value.trim()
  );
};
</script>
</body>
</html>
