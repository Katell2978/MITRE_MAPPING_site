<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Recherche CVE par CPE ‚Äì Liste simple (tri + CVSS)</title>

<style>
:root{
  --bg:#0b1020; --card:#121a33; --txt:#e9ecff; --muted:#aab3da;
  --accent:#7aa2ff; --line:#26325f;
  --mono: ui-monospace, Menlo, Consolas, monospace;
  --sans: system-ui, Segoe UI, Roboto, Arial, sans-serif;
}
body{margin:0;font-family:var(--sans);background:linear-gradient(160deg,#070a15,var(--bg));color:var(--txt);}
header,main{max-width:1100px;margin:auto;padding:18px}
h1{margin:0 0 8px;font-size:22px}
.card{background:rgba(18,26,51,.95);border:1px solid var(--line);border-radius:14px;padding:14px;margin-top:14px}
.row{display:flex;gap:10px;align-items:center}
input,button{padding:10px;border-radius:10px;border:1px solid var(--line);background:#0a0f22;color:var(--txt)}
button{cursor:pointer}
button:hover{border-color:#3b4aa0}
.mono{font-family:var(--mono)}
.muted{color:var(--muted)}
.tag{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 6px;font-size:11px;margin-left:6px}
ul{margin:6px 0 0 18px}
li{margin:6px 0}
.hr{height:1px;background:var(--line);margin:12px 0}
</style>
</head>

<body>
<header>
  <h1>Recherche de CVE √† partir d‚Äôun CPE</h1>
  <p class="muted">
    Liste des CVE NVD pour un CPE donn√©,<br/>
    tri√©es du <b>plus r√©cent au plus ancien</b> avec affichage du <b>CVSS base</b>.
  </p>
</header>

<main>
  <div class="card">
    <div class="row">
      <input id="cpeInput" class="mono" style="flex:1"
        placeholder="cpe:2.3:o:google:android:14.0:*:*:*:*:*:*:*" />
      <button id="searchBtn">Rechercher</button>
      <span id="status" class="muted">Pr√™t.</span>
    </div>
  </div>

  <div id="results"></div>
</main>

<script>
/* =====================
   CONFIG
   ===================== */
const NVD_API = "https://services.nvd.nist.gov/rest/json/cves/2.0";

/* =====================
   UTILS
   ===================== */
function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g,c=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}
function setStatus(t){
  document.getElementById("status").textContent = t;
}
function isLikelyCpe(x){
  return /^cpe:2\.3:/i.test(x);
}

/* =====================
   SEARCH CPE ‚Üí CVE
   ===================== */
async function searchCPE(cpe){
  if(!isLikelyCpe(cpe)){
    alert("CPE invalide (doit commencer par cpe:2.3:)");
    return;
  }

  setStatus("Recherche en cours‚Ä¶");

  const url =
    `${NVD_API}?cpeName=${encodeURIComponent(cpe)}&resultsPerPage=50`;

  const json = await fetch(url).then(r => r.json());
  renderResults(cpe, json);

  setStatus("R√©sultats affich√©s");
}

/* =====================
   CVSS BASE (LOCAL)
   ===================== */
function getCvssBase(cve){
  const m40 = cve.metrics?.cvssMetricV40?.[0]?.cvssData;
  if(m40) return {score:m40.baseScore, sev:m40.baseSeverity, v:"4.0"};
  const m31 = cve.metrics?.cvssMetricV31?.[0]?.cvssData;
  if(m31) return {score:m31.baseScore, sev:m31.baseSeverity, v:"3.1"};
  const m30 = cve.metrics?.cvssMetricV30?.[0]?.cvssData;
  if(m30) return {score:m30.baseScore, sev:m30.baseSeverity, v:"3.0"};
  const m2  = cve.metrics?.cvssMetricV2?.[0]?.cvssData;
  if(m2)  return {score:m2.baseScore, sev:m2.baseSeverity || "", v:"2.0"};
  return null;
}

/* =====================
   RENDER + TRI PAR DATE
   ===================== */
function renderResults(cpe, json){
  const vulns = json.vulnerabilities || [];
  const wrap = document.getElementById("results");

  if(!vulns.length){
    wrap.innerHTML = `<div class="card muted">Aucune CVE trouv√©e.</div>`;
    log("Aucune CVE retourn√©e par le NVD");
    return;
  }

  // Tri par date d√©croissante
  vulns.sort((a,b)=>{
    const da = new Date(a.cve.published || 0);
    const db = new Date(b.cve.published || 0);
    return db - da;
  });

  log(`${vulns.length} CVE re√ßues, tri√©es par date`);

  wrap.innerHTML = `
  <div class="card">
    <h2>R√©sultats pour <span class="mono">${escapeHtml(cpe)}</span></h2>
    <div class="muted">${vulns.length} CVE affich√©es</div>
    <div class="hr"></div>
    <ul>
      ${vulns.map(v=>{
        const c = v.cve;
        const date = c.published ? c.published.split("T")[0] : "n/a";
        const cvss = getCvssBase(c);

        // üîó Lien vers ta page de d√©tail CVE
        const link = `CVEsearch.htm?cve=${c.id}`;

        return `
        <li>
          ${link}<b>${c.id}</b></a>
          <span class="muted">(${date})</span>
          ${cvss ? `<span class="tag">CVSS ${cvss.score} ${cvss.sev} v${cvss.v}</span>` : ``}
          <div class="muted">${escapeHtml(c.descriptions?.[0]?.value || "")}</div>
        </li>`;
      }).join("")}
    </ul>
  </div>`;
}
  
/* =====================
   UI
   ===================== */
document.getElementById("searchBtn").onclick = ()=>{
  searchCPE(document.getElementById("cpeInput").value.trim());
};
</script>
</body>
</html>
