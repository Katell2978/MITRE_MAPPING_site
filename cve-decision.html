<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kat‚ÄëForce ‚Äî CVE Decision (SSVC)</title>
    <LINK rel="stylesheet" type="text/css" href="style3.css">
    <!-- ‚úÖ jsPDF correct (√©vite runAnalysis undefined par arr√™t JS) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</head>

<body>
<header>
  <nav>
    üîç Analyseur</a>
    üî≠ Veille</a>
    ‚úÖ D√©cision SSVC</a>
  </nav>

  <h1>Kat‚ÄëForce ‚Äî D√©cision & Priorisation (SSVC)</h1>
  <p>
    Cette page combine : triage rapide (CVSS/EPSS/KEV), contexte NVD (dates, refs, CPE),
    et une d√©cision SSVC structur√©e (Exploitation / Exposure / Technical Impact).
  </p>
</header>

<main>
  <!-- INPUT -->
  <div class="card">
    <div class="row">
      <select id="mode">
        <option value="cve">Recherche par CVE</option>
        <option value="cpe">Recherche par CPE</option>
      </select>

      <input id="queryInput" type="text" value="CVE-2025-32058" placeholder="Ex: CVE-2025-32058" />

      <button id="goBtn">Analyser</button>
      <button id="pdfBtn" disabled>Exporter PDF (Decision record)</button>
    </div>
    <div id="status" class="muted small" style="margin-top:8px;">Pr√™t.</div>
  </div>

  <!-- KPI -->
  <div class="card">
    <h2>R√©sum√© & Scores</h2>
    <div class="kpiGrid">
      <div class="kpi">
        <div class="title">CVSS v3.x</div>
        <div id="cvss3" class="value">‚Äî</div>
        <div id="cvss3vec" class="sub">‚Äî</div>
      </div>
      <div class="kpi">
        <div class="title">CVSS v4.0</div>
        <div id="cvss4" class="value">‚Äî</div>
        <div id="cvss4vec" class="sub">‚Äî</div>
      </div>
      <div class="kpi">
        <div class="title">EPSS (30j)</div>
        <div id="epss" class="value">‚Äî</div>
        <div id="epssPct" class="sub">‚Äî</div>
      </div>
      <div class="kpi">
        <div class="title">KEV (CISA)</div>
        <div id="kev" class="value">‚Äî</div>
        <div id="kevDate" class="sub">‚Äî</div>
      </div>
      <div class="kpi">
        <div class="title">Badges</div>
        <div id="badges" class="sub">‚Äî</div>
      </div>
    </div>

    <div id="exploitBanner" class="banner" style="display:none;">
      <h3>Exploitability (CVSS vector hints)</h3>
      <div id="exploitPills"></div>
    </div>
  </div>

  <!-- DETAILS -->
  <div class="card">
    <h2>D√©tail CVE / Contexte</h2>
    <div id="cveDetail" class="small muted">‚Äî</div>
    <hr />
    <details>
      <summary>Produits affect√©s (CPE)</summary>
      <div id="cpeList" class="small mono muted">‚Äî</div>
    </details>

    <div style="height:10px"></div>

    <details>
      <summary>R√©f√©rences NVD</summary>
      <div id="refList" class="small muted">‚Äî</div>
    </details>
  </div>

  <!-- SSVC DECISION -->
  <div class="card">
    <h2>SSVC ‚Äî Aide √† la d√©cision</h2>
    <p class="small muted">
      Exploitation = evidence-based (None/Public PoC/Active). SSVC rappelle que ce n‚Äôest pas un mod√®le pr√©dictif ;
      EPSS peut aider √† alerter mais ne ‚Äúprouve‚Äù pas l‚Äôexploitation. [3](https://certcc.github.io/SSVC/reference/decision_points/exploitation/)[8](https://github.com/CERTCC/SSVC/blob/main/docs/reference/decision_points/exploitation.md)
    </p>

    <div class="grid">
      <div>
        <h3>Decision points</h3>

        <label>Exploitation (SSVC:E)</label><br>
        <select id="dpExploitation">
          <option value="N">None (no PoC, no evidence)</option>
          <option value="P">Public PoC</option>
          <option value="A">Active (in the wild)</option>
        </select>
        <div class="small muted">D√©finitions SSVC Exploitation. [3](https://certcc.github.io/SSVC/reference/decision_points/exploitation/)</div>

        <div style="height:10px"></div>

        <label>System Exposure (SSVC:EXP)</label><br>
        <select id="dpExposure">
          <option value="S">Small</option>
          <option value="C">Controlled</option>
          <option value="O" selected>Open</option>
        </select>
        <div class="small muted">Si inconnu, SSVC recommande d‚Äôassumer ‚ÄúOpen‚Äù. [4](https://certcc.github.io/SSVC/reference/decision_points/system_exposure/)</div>

        <div style="height:10px"></div>

        <label>Technical Impact (SSVC:TI)</label><br>
        <select id="dpTechImpact">
          <option value="P">Partial</option>
          <option value="T">Total</option>
        </select>
        <div class="small muted">D√©finitions SSVC Technical Impact. [5](https://certcc.github.io/SSVC/reference/decision_points/technical_impact/)</div>
      </div>

      <div>
        <h3>Outcome (auto)</h3>
        <div id="ssvcOutcome" class="card" style="background:rgba(15,22,48,.55); border-style:dashed;">
          ‚Äî
        </div>
        <div class="small muted">
          Outcomes possibles : CISA (Track/Track*/Attend/Act) [7](https://www.cisa.gov/stakeholder-specific-vulnerability-categorization-ssvc)
          et DSOI (Defer/Scheduled/Out-of-Cycle/Immediate). [6](https://certcc.github.io/SSVC/reference/decision_points/outcomes/)
        </div>
      </div>
    </div>
  </div>

  <!-- Optional drilldown -->
  <div class="card">
    <h2>Drilldown (optionnel) ‚Äî CWE ‚Üí CAPEC ‚Üí ATT&CK</h2>
    <p class="small muted">
      Active si tu as <span class="mono">data/cwe_db.json</span>, <span class="mono">data/capec_db.json</span>,
      <span class="mono">data/techniques_db.json</span> 
    </p>
    <div id="drilldown" class="muted">‚Äî</div>
  </div>

  <!-- Log -->
  <div class="card">
    <div class="row" style="justify-content:space-between">
      <h2 style="margin:0">Moniteur / Debug</h2>
      <button id="clearLogBtn" style="padding:6px 10px">Vider</button>
    </div>
    <div id="log"></div>
  </div>

</main>

<footer class="small muted" style="padding:18px; max-width:1180px; margin:0 auto;">
  <hr />
  Sources : NVD (CVE API), EPSS (FIRST), KEV (CISA), SSVC (CERT/CC). [7](https://www.cisa.gov/stakeholder-specific-vulnerability-categorization-ssvc)[10](https://github.com/CERTCC/SSVC)
</footer>

<!-- Modules -->
scripts/ssvc-engine.jsscript>
scripts/decision-pdf.jsscript>

<script type="module">
  import { SSVC } from "./scripts/ssvc-engine.js";
  import { generateDecisionPdf } from "./scripts/decision-pdf.js";

  const DEBUG = true;
  const cache = new Map();

  const $ = (id) => document.getElementById(id);
  const now = () => new Date().toLocaleTimeString("fr-FR", {hour12:false});

  function log(msg) {
    if (!DEBUG) return;
    const el = $("log");
    el.textContent += `[${now()}] ${msg}\n`;
    el.scrollTop = el.scrollHeight;
  }
  function setStatus(msg) { $("status").textContent = msg; }
  function esc(s){ return String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&','<':'<','>':'>','"':'"','\'':'\''}[c])); }

  async function fetchJson(url) {
    if (cache.has(url)) return cache.get(url);
    const p = fetch(url, { cache:"no-store" }).then(async r => {
      if (!r.ok) throw new Error(`HTTP ${r.status} on ${url}`);
      return r.json();
    });
    cache.set(url, p);
    return p;
  }

  function pickCvss(metrics){
    const m40 = metrics?.cvssMetricV40?.[0]?.cvssData;
    const m31 = metrics?.cvssMetricV31?.[0]?.cvssData;
    const m30 = metrics?.cvssMetricV30?.[0]?.cvssData;
    return { cvss4: m40 || null, cvss3: (m31 || m30 || null) };
  }

  function extractCpes(configurations){
    const out = [];
    function walk(node){
      if (!node) return;
      (node.cpeMatch || []).forEach(m => {
        if (m.criteria) out.push(m.criteria);
        else if (m.cpe23Uri) out.push(m.cpe23Uri);
      });
      (node.nodes || []).forEach(walk);
      (node.children || []).forEach(walk);
    }
    (configurations || []).forEach(walk);
    return [...new Set(out)];
  }

  function getCwes(weaknesses){
    const cwes = [];
    (weaknesses || []).forEach(w => {
      (w.description || []).forEach(d => {
        const m = (d.value || "").match(/CWE-(\d{1,5})/);
        if (m) cwes.push(`CWE-${m[1]}`);
      });
    });
    return [...new Set(cwes)];
  }

  function vectorPills(cvss3){
    if (!cvss3?.vectorString) return [];
    const v = cvss3.vectorString;
    const parts = v.split("/");
    const kv = {};
    parts.forEach(p => {
      const [k,val] = p.split(":");
      if (k && val && k !== "CVSS") kv[k]=val;
    });
    const pills = [];
    ["AV","AC","PR","UI","S","C","I","A"].forEach(k=>{
      if (kv[k]) pills.push(`<span class="pill ${["C","I","A"].includes(k) ? "warn":""}">${k}:${esc(kv[k])}</span>`);
    });
    return pills;
  }

  // Suggest exploitation DP from signals:
  // - KEV yes => Active (A)
  // - else (optional heuristic) if EPSS high => suggest Public PoC (P) but keep it editable.
  function suggestExploitation(kevIn, epssVal){
    if (kevIn) return "A";
    // EPSS is predictive, not evidence; we suggest "P" only as default assist.
    if (typeof epssVal === "number" && epssVal >= 0.20) return "P";
    return "N";
  }

function renderOutcome(){
  const decision = SSVC.decide({
    exploitation: $("dpExploitation").value,
    exposure: $("dpExposure").value,
    techImpact: $("dpTechImpact").value
  });

  const cisaClass =
    decision.outcome.cisa === "ACT" ? "crit" :
    decision.outcome.cisa === "ATTEND" ? "warn" : "";

  const dsoiClass =
    decision.outcome.dsoi === "I" ? "crit" :
    decision.outcome.dsoi === "O" ? "warn" : "";

  $("ssvcOutcome").innerHTML = `
    <div class="pill ${cisaClass}">
      CISA: <b>${esc(decision.outcome.cisaLabel)}</b>
    </div>
    <div class="pill ${dsoiClass}">
      DSOI: <b>${esc(decision.outcome.dsoiLabel)}</b>
    </div>
    <div class="small muted" style="margin-top:8px;">
      ${esc(decision.rationale)}
    </div>
  `;

  return decision;
}

  async function drilldown(cweId){
    // Optional: loads local JSON like CVESearch page expects [2](https://grouperenault-my.sharepoint.com/personal/catherine_tanguy_renault_com/Documents/Fichiers%20Microsoft%20Copilot%20Chat/CVESearch.html)
    try{
      const [cweDb, capecDb, techDb] = await Promise.all([
        fetchJson("./data/cwe_db.json"),
        fetchJson("./data/capec_db.json"),
        fetchJson("./data/techniques_db.json")
      ]);

      const rel = cweDb?.[cweId.replace("CWE-","")];
      const capecIds = (rel?.RelatedAttackPatterns || []).map(String);
      const capecs = capecIds.map(id => ({ id, name: capecDb?.[id]?.name || "" }));

      $("drilldown").innerHTML = `
        <div class="small muted">CWE s√©lectionn√©e : <span class="mono">${esc(cweId)}</span></div>
        <div class="small muted">CAPEC reli√©s : ${capecs.length}</div>
        <ul>
          ${capecs.slice(0,40).map(c=>`<li><a target="_blank" rel="noreferrer" href="https://capec.mitre.org/data/definitions/${c.id}.html">CAPEC-${c.id}</a> ‚Äî ${esc(c.name)}</li>`).join("")}
        </ul>
        ${capecs.length>40 ? `<div class="small muted">‚Ä¶ (${capecs.length-40} autres)</div>`:""}
      `;
    }catch(e){
      $("drilldown").innerHTML = `<div class="muted">Drilldown non disponible (data/*.json absents) ‚Äî ${esc(e.message)}</div>`;
    }
  }

  async function analyze(){
    const mode = $("mode").value;
    const q = $("queryInput").value.trim();
    $("pdfBtn").disabled = true;

    setStatus("Analyse en cours‚Ä¶");
    log(`Run mode=${mode} query=${q}`);

    try{
      if (mode === "cpe") {
        if (!/^cpe:2\.3:/i.test(q)) throw new Error("Format CPE attendu: cpe:2.3:...");
        const url = `https://services.nvd.nist.gov/rest/json/cves/2.0?cpeName=${encodeURIComponent(q)}&resultsPerPage=20&startIndex=0`;
        const json = await fetchJson(url);
        const vulns = json?.vulnerabilities || [];
        $("cveDetail").innerHTML = `<b>R√©sultats CPE</b> : ${esc(vulns.length)} CVE (affich√©es 20 max).`;
        $("cpeList").textContent = q;
        $("refList").innerHTML = `<div class="muted">Clique sur une CVE ci-dessous :</div>` + `<ul>` +
          vulns.map(v => `<li><a href="#" data-cve="${esc(v.cve.id)}">${esc(v.cve.id)}</a></li>`).join("") + `</ul>`;
        $("refList").querySelectorAll("a[data-cve]").forEach(a => {
          a.addEventListener("click", (ev) => {
            ev.preventDefault();
            $("mode").value = "cve";
            $("queryInput").value = a.getAttribute("data-cve");
            analyze();
            window.scrollTo({top:0, behavior:"smooth"});
          });
        });
        setStatus("OK (CPE). Clique une CVE.");
        return;
      }

      // CVE mode
      const cveId = q.toUpperCase();
      if (!/^CVE-\d{4}-\d{4,}$/i.test(cveId)) throw new Error("Format CVE invalide (ex: CVE-2025-32058).");

      const nvd = await fetchJson(`https://services.nvd.nist.gov/rest/json/cves/2.0?cveId=${encodeURIComponent(cveId)}`);
      const cve = nvd?.vulnerabilities?.[0]?.cve;
      if (!cve) throw new Error("CVE non trouv√©e dans NVD.");

      const desc = cve.descriptions?.find(d => d.lang === "fr")?.value
                || cve.descriptions?.find(d => d.lang === "en")?.value
                || "";

      const { cvss3, cvss4 } = pickCvss(cve.metrics);
      const cpes = extractCpes(cve.configurations);
      const refs = (cve.references || []).map(r => r.url).filter(Boolean);
      const cwes = getCwes(cve.weaknesses);

      // EPSS
      let epssVal = null, epssPct = null;
      try{
        const epss = await fetchJson(`https://api.first.org/data/v1/epss?cve=${encodeURIComponent(cveId)}`);
        epssVal = epss?.data?.[0]?.epss ? parseFloat(epss.data[0].epss) : null;
        epssPct = epss?.data?.[0]?.percentile ? parseFloat(epss.data[0].percentile) : null;
      }catch(e){ log("EPSS fetch failed: " + e.message); }

      // KEV
      let kevIn = false, kevDate = null;
      try{
        const kev = await fetchJson("https://raw.githubusercontent.com/cisagov/kev-data/main/known_exploited_vulnerabilities.json");
        const hit = (kev?.vulnerabilities || []).find(v => v?.cveID === cveId);
        kevIn = !!hit;
        kevDate = hit?.dateAdded || null;
      }catch(e){ log("KEV fetch failed: " + e.message); }

      // Render KPI
      $("cvss3").textContent = cvss3?.baseScore ?? "‚Äî";
      $("cvss3vec").textContent = cvss3?.vectorString ?? "‚Äî";
      $("cvss4").textContent = cvss4?.baseScore ?? "‚Äî";
      $("cvss4vec").textContent = cvss4?.vectorString ?? "‚Äî";
      $("epss").textContent = (typeof epssVal === "number") ? `${(epssVal*100).toFixed(2)}%` : "‚Äî";
      $("epssPct").textContent = (typeof epssPct === "number") ? `Percentile: ${(epssPct*100).toFixed(0)}e` : "‚Äî";
      $("kev").textContent = kevIn ? "Oui" : "Non";
      $("kevDate").textContent = kevIn ? (kevDate || "‚Äî") : "‚Äî";

      // Badges
      const badges = [];
      badges.push(`<span class="pill mono">${esc(cveId)}</span>`);
      if (kevIn) badges.push(`<span class="pill crit">KEV</span>`);
      if (typeof epssVal === "number" && epssVal >= 0.20) badges.push(`<span class="pill warn">EPSS high</span>`);
      if (cvss3?.baseScore >= 9.0) badges.push(`<span class="pill crit">CVSS v3 Critical</span>`);
      $("badges").innerHTML = badges.join(" ");

      // Exploit pills (from CVSS vector)
      const pills = vectorPills(cvss3);
      $("exploitBanner").style.display = pills.length ? "block" : "none";
      $("exploitPills").innerHTML = pills.join(" ");

      // Details
      $("cveDetail").innerHTML = `
        <div><b>${esc(cveId)}</b></div>
        <div class="muted">${esc(desc)}</div>
        <div class="small muted" style="margin-top:8px;">
          Published: <span class="mono">${esc(cve.published || "n/a")}</span> ¬∑
          Last modified: <span class="mono">${esc(cve.lastModified || "n/a")}</span>
        </div>
        <div class="small" style="margin-top:8px;">
          NVD: <a target="_blank" rel="noreferrer" href="https://nvd.nist.gov/vuln/detail/${encodeURIComponent(cveId)}">link</a> ¬∑
          EUVD: <a target="_blank" rel="noreferrer" href="https://euvd.enisa.europa.eu/vulnerability/${encodeURIComponent(cveId)}">link</a>
        </div>
        <div class="small muted" style="margin-top:8px;">
          CWE: ${cwes.length ? cwes.map(x=>`<span class="pill"><span class="mono">${esc(x)}</span></span>`).join("") : "‚Äî"}
        </div>
      `;

      // CPE list
      $("cpeList").innerHTML = cpes.length
        ? `<div class="small muted">${cpes.length} entr√©es</div><ul class="mono small">${cpes.slice(0,80).map(x=>`<li>${esc(x)}</li>`).join("")}</ul>${cpes.length>80?`<div class="small muted">‚Ä¶ (${cpes.length-80} autres)</div>`:""}`
        : `<div class="muted small">Aucune configuration CPE list√©e.</div>`;

      // Refs
      $("refList").innerHTML = refs.length
        ? `<ul class="small">${refs.slice(0,40).map(u=>`<li><a target="_blank" rel="noreferrer" href="${esc(u)}">${esc(u)}</a></li>`).join("")}</ul>${refs.length>40?`<div class="small muted">‚Ä¶ (${refs.length-40} autres)</div>`:""}`
        : `<div class="muted small">Aucune r√©f√©rence list√©e.</div>`;

      // Suggest SSVC Exploitation from KEV/EPSS (editable)
      $("dpExploitation").value = suggestExploitation(kevIn, epssVal);

      // Suggest technical impact from CVSS CIA (na√Øf): if C/I/A are High -> Total else Partial (editable)
      const vec = (cvss3?.vectorString || "");
      $("dpTechImpact").value = /C:H|I:H|A:H/.test(vec) ? "T" : "P";

      // Render SSVC outcome
      const decision = renderOutcome();

      // Optional drilldown: take first CWE if present
      if (cwes.length) drilldown(cwes[0]);

      // Enable PDF
      $("pdfBtn").disabled = false;
      $("pdfBtn").onclick = () => {
        const evidence = {
          cveId,
          cvss3Score: cvss3?.baseScore ?? null,
          cvss3Vector: cvss3?.vectorString ?? null,
          cvss4Score: cvss4?.baseScore ?? null,
          cvss4Vector: cvss4?.vectorString ?? null,
          epssPct: (typeof epssVal === "number") ? `${(epssVal*100).toFixed(2)}%` : null,
          epssPercentile: (typeof epssPct === "number") ? `${(epssPct*100).toFixed(0)}e` : null,
          kevIn,
          kevDate
        };

        const exposureMap = {S:"Small", C:"Controlled", O:"Open"};
        const tiMap = {P:"Partial", T:"Total"};
        const userInputs = {
          exposureLabel: exposureMap[$("dpExposure").value],
          techImpactLabel: tiMap[$("dpTechImpact").value]
        };

        generateDecisionPdf({
          evidence,
          ssvcDecision: decision,
          userInputs,
          debugText: $("log").textContent
        });
      };

      setStatus("OK. Decision SSVC calcul√©e et PDF exportable.");
    }catch(e){
      setStatus("Erreur: " + e.message);
      log("ERROR: " + e.message);
      $("pdfBtn").disabled = true;
    }
  }


  $("goBtn").addEventListener("click", analyze);
  $("mode").addEventListener("change", () => {
    $("queryInput").value = $("mode").value === "cve" ? "CVE-2025-32058" : "cpe:2.3:o:microsoft:windows_10:1607:*:*:*:*:*:*:*";
    setStatus("Pr√™t.");
  });

  ["dpExploitation","dpExposure","dpTechImpact"].forEach(id => {
    $(id).addEventListener("change", () => renderOutcome());
  });

  $("clearLogBtn").addEventListener("click", () => $("log").textContent = "");

  // Optional auto-run
  analyze();
</script>
</body>
</html>
