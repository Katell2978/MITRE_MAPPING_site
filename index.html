<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Kat-Force Analyser ‚Äì NVD ‚Üí CWE ‚Üí EMB3D</title>

  <!-- ‚úÖ jsPDF correct (√©vite runAnalysis undefined par arr√™t JS) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root {
      --bg:#070a15; --card:#121a33; --txt:#e9ecff; --accent:#7aa2ff;
      --bad:#f87171; --ok:#36d399; --warn:#fbbf24; --line:#26325f;
    }
    body { background:var(--bg); color:var(--txt); font-family:sans-serif; padding:20px; }
    h1 { border-bottom:2px solid var(--accent); padding-bottom:10px; margin:0; }
    nav a { color:var(--accent); margin-right:15px; text-decoration:none; font-weight:800; }
    .topbar { display:flex; justify-content:space-between; flex-wrap:wrap; }
    .card { background:var(--card); border:1px solid var(--line); border-radius:12px; padding:14px 16px; margin-top:14px; }
    .row { display:flex; gap:14px; flex-wrap:wrap; }
    .col { flex:1 1 340px; min-width:320px; }

    input, select {
      background:rgba(255,255,255,0.04); color:var(--txt);
      border:1px solid var(--line); border-radius:8px; padding:10px;
      font-weight:800;
    }
    button {
      background:var(--accent); border:none; padding:10px 16px;
      border-radius:8px; font-weight:900; cursor:pointer;
    }
    button:disabled { opacity:.6; }

    .grid { display:grid; grid-template-columns:repeat(3,minmax(240px,1fr)); gap:10px; }
    @media(max-width:900px){ .grid{grid-template-columns:repeat(2,1fr);} }
    @media(max-width:600px){ .grid{grid-template-columns:1fr;} }

    .kpi { background:rgba(255,255,255,0.03); border:1px solid var(--line); border-radius:10px; padding:10px; }
    .kpi .title { font-size:.75em; text-transform:uppercase; color:var(--accent); }
    .kpi .value { font-size:1.1em; font-weight:900; }
    .kpi .sub { font-size:.85em; opacity:.85; }

    .badge { display:inline-block; padding:4px 8px; border-radius:6px; font-size:.75em; font-weight:900; margin-right:6px; }
    .bg-bad{background:var(--bad);color:#000}
    .bg-warn{background:var(--warn);color:#000}
    .bg-info{background:rgba(122,162,255,.2);border:1px solid rgba(122,162,255,.4)}

    .banner { border:1px solid var(--line); border-radius:10px; padding:10px; margin-top:10px; }
    .pill { border:1px solid rgba(122,162,255,.4); border-radius:999px; padding:6px 10px; font-weight:900; }
    .pill.warn{border-color:rgba(251,191,36,.7)}
    .pill.crit{border-color:rgba(248,113,113,.7)}

    .emb3d-card { background:rgba(122,162,255,.08); border:1px solid var(--accent); border-radius:10px; padding:12px; margin-top:10px; }

    #logs {
      white-space:pre-wrap; font-family:monospace; font-size:.85em;
      background:rgba(0,0,0,.25); border:1px solid var(--line);
      border-radius:10px; padding:10px; max-height:240px; overflow:auto;
    }
  </style>
</head>

<body>

<nav>
  <a href="index.html">üîç Analyseur</a>
  <a href="veille.html">üî≠ Veille</a>
</nav>

<div class="topbar">
  <h1>üß† Kat‚ÄëForce Analyser</h1>
  <div class="muted">Mapping : CVE ‚Üí CWE ‚Üí EMB3D</div>
</div>

<div class="card">
  <label>CVE √† analyser</label><br>
  <input id="cveInput" value="CVE-2025-32058">
  <button id="runBtn" onclick="runAnalysis()">üöÄ Lancer l‚Äôanalyse</button>
  <span id="status">Pr√™t.</span>
</div>

<div class="row">
  <div class="col card">
    <h2>R√©sum√© & Scores</h2>
    <div class="grid">
      <div class="kpi"><div class="title">CVSS v3</div><div id="cvss3" class="value">‚Äî</div><div id="cvss3vec" class="sub">‚Äî</div></div>
      <div class="kpi"><div class="title">CVSS v4</div><div id="cvss4" class="value">‚Äî</div><div id="cvss4vec" class="sub">‚Äî</div></div>
      <div class="kpi"><div class="title">EPSS</div><div id="epss" class="value">‚Äî</div><div id="epssPct" class="sub">‚Äî</div></div>
      <div class="kpi"><div class="title">KEV</div><div id="kev" class="value">‚Äî</div><div id="kevDate" class="sub">‚Äî</div></div>
      <div class="kpi"><div class="title">Badges</div><div id="badges">‚Äî</div></div>
    </div>

    <div id="exploitBanner" class="banner" style="display:none">
      <h3>Conditions d‚Äôexploitation</h3>
      <div id="exploitPills"></div>
    </div>
  </div>

  <div class="col card">
    <h2>D√©tail</h2>
    <div id="desc">‚Äî</div>
  </div>
</div>

<div class="card">
  <h2>CPE</h2>
  <div id="cpe">‚Äî</div>
  <button id="cpeToggleBtn" style="display:none" onclick="toggleCpeView()">Voir tous</button>
</div>

<div class="row">
  <div class="col card">
    <h2>CWE & Pivot EMB3D</h2>
    <div id="cwe">‚Äî</div>
    <div id="emb3d-info"></div>
  </div>
  <div class="col card">
    <h2>CAPEC</h2>
    <div id="capec">‚Äî</div>
  </div>
</div>

<div class="card">
  <h2>R√©f√©rences</h2>
  <div id="refs">‚Äî</div>
</div>

<div class="card">
  <h2>Logs (debug)</h2>
  <div id="logs">‚Äî</div>
</div>

<script>
/* ================= CONFIG ================= */
const DEBUG = true;

/* ================= DEBUG ================= */
function log(msg){
  if(!DEBUG) return;
  const el=document.getElementById("logs");
  if(el.textContent==="‚Äî") el.textContent="";
  el.textContent+=`[${new Date().toLocaleTimeString()}] ${msg}\n`;
}
function setStatus(s){document.getElementById("status").textContent=s}

/* ================= EMB3D ================= */
const emb3dMapping={
  "CWE-787":{tid:"T1.1",threat:"Memory Corruption",category:"App",iot:"RCE firmware"},
  "CWE-798":{tid:"T3.1",threat:"Hardcoded Credentials",category:"System",iot:"Root creds"},
  "CWE-295":{tid:"T4.3",threat:"MITM",category:"Network",iot:"TLS bypass"}
};

/* ================= ORCHESTRATION ================= */
async function runAnalysis(){
  const cveId=document.getElementById("cveInput").value.trim().toUpperCase();
  if(!/^CVE-\d{4}-\d{4,}$/.test(cveId)){alert("Format CVE invalide");return;}
  document.getElementById("runBtn").disabled=true;
  setStatus("Analyse en cours‚Ä¶");
  log(`Analyse ${cveId}`);

  try{
    const nvd=await fetch(`https://services.nvd.nist.gov/rest/json/cves/2.0?cveId=${cveId}`).then(r=>r.json());
    const cve=nvd.vulnerabilities[0].cve;

    const desc=cve.descriptions.find(d=>d.lang==="fr")?.value||
               cve.descriptions.find(d=>d.lang==="en")?.value||"‚Äî";
    document.getElementById("desc").textContent=desc;

    const cvss3=cve.metrics?.cvssMetricV31?.[0]?.cvssData;
    const cvss4=cve.metrics?.cvssMetricV40?.[0]?.cvssData;

    document.getElementById("cvss3").textContent=cvss3?.baseScore??"‚Äî";
    document.getElementById("cvss3vec").textContent=cvss3?.vectorString??"‚Äî";
    document.getElementById("cvss4").textContent=cvss4?.baseScore??"‚Äî";
    document.getElementById("cvss4vec").textContent=cvss4?.vectorString??"‚Äî";

    const epss=await fetch(`https://api.first.org/data/v1/epss?cve=${cveId}`).then(r=>r.json());
    document.getElementById("epss").textContent=(epss.data[0].epss*100).toFixed(2)+"%";
    document.getElementById("epssPct").textContent="Percentile "+(epss.data[0].percentile*100).toFixed(0);

    const kev=await fetch("https://raw.githubusercontent.com/cisagov/kev-data/main/known_exploited_vulnerabilities.json").then(r=>r.json());
    const hit=kev.vulnerabilities.find(v=>v.cveID===cveId);
    document.getElementById("kev").textContent=hit?"Oui":"Non";
    document.getElementById("kevDate").textContent=hit?hit.dateAdded:"‚Äî";

    const cweList=[];
    (cve.weaknesses||[]).forEach(w=>w.description.forEach(d=>d.value.startsWith("CWE-")&&cweList.push(d.value)));
    document.getElementById("cwe").innerHTML="<ul>"+cweList.map(c=>`<li>${c}</li>`).join("")+"</ul>";

    const emb=cweList.find(c=>emb3dMapping[c]);
    if(emb){
      const m=emb3dMapping[emb];
      document.getElementById("emb3d-info").innerHTML=
        `<div class="emb3d-card"><b>${m.tid}</b> ‚Äì ${m.threat}<br>${m.iot}</div>`;
    }

    setStatus("‚úÖ Analyse termin√©e");
  }catch(e){
    log("ERREUR "+e.message);
    setStatus("Erreur");
  }finally{
    document.getElementById("runBtn").disabled=false;
  }
}

window.onload=runAnalysis;
</script>
</body>
</html>
