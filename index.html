<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kat-Force Analyser ‚Äì NVD ‚Üí CWE ‚Üí CAPEC ‚Üí ATT&CK ‚Üí ATM</title>

<style>
:root{
  --bg:#0b1020; --card:#121a33; --txt:#e9ecff; --muted:#aab3da;
  --accent:#7aa2ff; --ok:#36d399; --warn:#fbbf24; --bad:#f87171; --line:#26325f;
  --ent:#7aa2ff; --mob:#d299ff; --ics:#39d353;
  --mono: ui-monospace, Menlo, Consolas, monospace;
}
body{margin:0;font-family:system-ui,sans-serif;background:linear-gradient(160deg,#070a15,var(--bg));color:var(--txt);font-size:14px;}
header,main,.monitor{max-width:1300px;margin:auto;padding:18px}
.card{background:rgba(18,26,51,.95);border:1px solid var(--line);border-radius:14px;padding:18px;margin-top:14px}
.row{display:flex;gap:10px;align-items:center}
input,button{padding:12px;border-radius:10px;border:1px solid var(--line);background:#0a0f22;color:var(--txt)}
button{cursor:pointer;font-weight:bold;background:var(--accent);color:#000;border:none}
.badge{padding:4px 10px;border-radius:6px;font-weight:bold;font-size:11px;text-transform:uppercase;border:1px solid transparent}
.sev-CRITICAL{background:rgba(248,113,113,0.2);color:var(--bad);border-color:var(--bad)}
.kev-active{background:var(--bad);color:white;animation:pulse 2s infinite}
@keyframes pulse { 0% {opacity:1} 50% {opacity:0.7} 100% {opacity:1} }
.grid-3{display:grid;grid-template-columns:repeat(auto-fit, minmax(300px, 1fr));gap:15px;margin-top:15px}
.matrix-card{border-top:4px solid var(--accent);padding:10px;background:rgba(255,255,255,0.03);border-radius:8px}
#pivotSvg{width:100%;height:500px;background:rgba(0,0,0,0.2);border-radius:10px;border:1px solid var(--line);margin-top:20px}
.log{font-family:var(--mono);font-size:12px;max-height:150px;overflow:auto;background:#000;padding:10px;border-radius:8px}
</style>
</head>

<body>
<header>
  <h1>CVE Analyser By Katell2978</h1>
  <p class="muted">Mapping complet : NVD (CVE) ‚Üí CWE ‚Üí CAPEC ‚Üí ATT&CK (Matrices) ‚Üí ATM Perso</p>
</header>

<main>
  <div class="card">
    <div class="row">
      <input id="cveInput" class="mono" style="flex:1" placeholder="CVE-2023-34362" value="CVE-2023-34362" />
      <button id="searchBtn">Lancer l'Analyse Totale</button>
      <span id="status" class="muted">Pr√™t.</span>
    </div>
  </div>

  <div id="results"></div>
</main>

<div class="monitor">
  <div class="card">
    <b>Logs d'ex√©cution</b>
    <div id="log" class="log"></div>
  </div>
</div>
<div style="background:#111; padding:10px; margin-top:20px;"> <svg id="pivotSvg" width="100%" height="400px"></svg> </div>
<script>

/* ================= CONFIG ================= */
const APIS = {
    nvd: "https://services.nvd.nist.gov/rest/json/cves/2.0?cveId=",
    kev: "build/kev.json"
};

let MITRE_INDEX = {}, CWE_DB = {}, CAPEC_DB = {}, ATM_DB = [];

/* ================= CHARGEMENT ================= */
// debut fonction loadallbase
async function loadAllBases() {
    if (Object.keys(CWE_DB).length > 0) return;
    console.log("üöÄ Tentative de chargement des bases...");
    try {
        const [m, cwe, capec, atmText] = await Promise.all([
            fetch('build/mitre_map_index.json').then(r => r.json()).catch(e => { console.error("Index MITRE manquant"); return {}; }),
            fetch('data/cwe_db.json').then(r => r.json()),
            fetch('data/capec_db.json').then(r => r.json()),
            fetch('data/ATM-matrix-TTP.csv').then(r => r.text()).catch(() => "")
        ]);
        
        MITRE_INDEX = m; CWE_DB = cwe; CAPEC_DB = capec;
        ATM_DB = parseATM(atmText);
        
        console.log("‚úÖ Bases charg√©es !", {
            mitre: Object.keys(MITRE_INDEX).length, 
            cwe: Object.keys(CWE_DB).length,
            capec: Object.keys(CAPEC_DB).length,
            atm: ATM_DB.length
        });
    } catch (e) {
        console.error("‚ùå Erreur critique lors du chargement:", e);
    }
}// fin fonction loadallbase
// debut fonction parseATM  
function parseATM(csv) {
    if(!csv || csv.length < 10) return [];
    return csv.split(/\r?\n/).slice(1).filter(l => l.trim()).map(line => {
        const c = line.split(";").map(x => x.trim());
        return { tactic: c[0], id: c[1], name: c[2], techniques: (c[3]||"").split(",").map(t=>t.trim()).filter(Boolean) };
    });
}
// fin fonction parseATM  
/* ================= ANALYSE ================= */
async function searchCVE() {
    const id = document.getElementById('cveInput').value.trim().toUpperCase();
    if(!id) return;
    
    document.getElementById("status").textContent = "Analyse en cours...";
    await loadAllBases();

    try {
        const nvdRes = await fetch(APIS.nvd + id).then(r => r.json());
        const kevRes = await fetch(APIS.kev).then(r => r.json()).catch(() => ({ vulnerabilities: [] }));
        
        const cve = nvdRes.vulnerabilities?.[0]?.cve;
        if(!cve) {
            document.getElementById("status").textContent = "CVE non trouv√©e.";
            return;
        }
        
        const isKev = (kevRes.vulnerabilities || []).some(v => v.cveID === id);
        document.getElementById("status").textContent = "Analyse termin√©e.";
        renderUI(cve, isKev);
    } catch (e) { 
        console.error(e);
        document.getElementById("status").textContent = "Erreur de recherche.";
    }
}
//Debut check mitre campaign - en cours de debug
async function checkMitreCampaigns(cveId) {
  const area = document.getElementById("campaign-area");
  if (!area) return;

  area.innerHTML = `<span class="badge" style="background:#555">MITRE ATT&CK : analyse‚Ä¶</span>`;

  try {
    const res = await fetch(
      "https://raw.githubusercontent.com/mitre/cti/master/enterprise-attack/enterprise-attack.json"
    );
    const stix = await res.json();

    const hits = (stix.objects || []).filter(o =>
      (o.type === "campaign" || o.type === "intrusion-set") &&
      JSON.stringify(o).includes(cveId)
    );

    if (hits.length === 0) {
      area.innerHTML = `<span class="badge" style="background:#2ecc71">Aucune campagne trouv√©e dans la base du Mitre Att&ck</span>`;
      return;
    }

    area.innerHTML = hits.slice(0, 6).map(h => `
      <div class="card" style="border-left:4px solid #e74c3c; padding:10px; margin-bottom:5px;">
        <strong>${h.name || "(sans nom)"}</strong><br/>
        <span style="font-size:0.85em; color:#bbb">${h.type}</span>
      </div>
    `).join("");

    if (hits.length > 6) {
      area.innerHTML += `<div class="muted" style="margin-top:6px">+${hits.length - 6} autre(s) r√©sultat(s)‚Ä¶</div>`;
    }

  } catch (e) {
    console.error(e);
    area.innerHTML = `<span class="badge" style="background:#f87171">Erreur MITRE</span>`;
  }
}
// >fin fonction checkmitre comapign - en cours de debug

// Debut fonction check certFR - pas valid√©e 
async function checkCertFR(cveId) {
  const area = document.getElementById("certfr-area");
  if (!area) return;

  area.innerHTML = `<span class="badge" style="background:#555">CERT‚ÄëFR : analyse‚Ä¶</span>`;

  try {
    const res = await fetch(`https://vulnerability.circl.lu/api/cve/${cveId}`);
    const data = await res.json();

    const certRefs = (data.references || []).filter(r =>
      r.source && r.source.includes("CERT-FR")
    );

    if (certRefs.length === 0) {
      area.innerHTML =
        `<span class="badge" style="background:#2ecc71">Aucun bulletin CERT‚ÄëFR touv√©</span>`;
      return;
    }

    area.innerHTML = certRefs.map(r => `
      <div class="card" style="border-left:4px solid #fbbf24; padding:10px; margin-bottom:5px;">
        <strong>${r.id || "CERT‚ÄëFR"}</strong><br/>
        <a href="${r.url}" target="_blank">Consulter le bulletin</a>
      </div>
    `).join("");

  } catch (e) {
    console.error(e);
    area.innerHTML =
      `<span class="badge" style="background:#f87171">Erreur CERT‚ÄëFR</span>`;
  }
}
  // fin fonction check certFR - pas valid√©e  
function renderUI(cve, isKev) {
    // 1. Extraction du Score et des M√©triques CVSS 3.1
    const metrics = cve.metrics?.cvssMetricV31?.[0]?.cvssData || 
                    cve.metrics?.cvssMetricV30?.[0]?.cvssData || {};
    const score = metrics.baseScore || "N/A";
    const severity = metrics.baseSeverity || "UNKNOWN";
    const vector = metrics.vectorString || "Non sp√©cifi√©";

    // 2. Extraction des CWE
    const cwes = (cve.weaknesses || []).flatMap(w => w.description.map(d => d.value.split('-')[1])).filter(Boolean);
    
    // 3. Extraction des CPE (Configurations affect√©es)
    const cpes = (cve.configurations || []).flatMap(conf => 
        conf.nodes.flatMap(node => node.cpeMatch.map(m => m.criteria))
    ).slice(0, 5); // On limite √† 5 pour ne pas surcharger

    // 4. Extraction des liens Sources
    const refs = (cve.references || []).slice(0, 5);

    document.getElementById("results").innerHTML = `
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>${cve.id} ${isKev ? '<span class="badge kev-active">‚ö†Ô∏è KEV</span>' : ''}</h2>
                <div class="badge sev-${severity}" style="font-size:1.2em; padding:10px 20px;">
                    CVSS ${score} (${severity})
                </div>
            </div>

            <p style="color:var(--accent); font-size:0.9em; margin-bottom:15px;"><strong>Vector:</strong> ${vector}</p>
            <p style="background:rgba(255,255,255,0.05); padding:15px; border-radius:5px; border-left:4px solid var(--accent);">
                ${cve.descriptions.find(d => d.lang === 'en')?.value || "Pas de description."}
            </p>

            <div class="grid-3" style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:15px; margin-top:20px;">
                <div class="matrix-card">
                    <h3>CWE Faiblesses</h3>
                    <div id="cwe-area"></div>
                </div>
                
                <div class="matrix-card">
                    <h3>CPE Affect√©s</h3>
                    <ul style="font-size:0.8em; color:#bbb; padding-left:15px;">
                        ${cpes.map(c => `<li>${c}</li>`).join('') || "Aucun CPE list√©"}
                        ${cpes.length >= 5 ? '<li>...</li>' : ''}
                    </ul>
                </div>

                <div class="matrix-card">
                    <h3>Sources & Liens</h3>
                    <ul style="font-size:0.8em; padding-left:15px;">
                        ${refs.map(r => `<li><a href="${r.url}" target="_blank" style="color:var(--link)">${r.source || 'Lien'}</a></li>`).join('')}
                    </ul>
                </div>
            </div>

<!-- Debut complement pour affichage comapgne et cert-fr -->
<div class="matrix-card" style="margin-top:20px;">
  <h3>Campagnes & Bulletins</h3>

  <div id="campaign-area" style="margin-bottom:10px;">
    <span class="badge" style="background:#555">MITRE ATT&CK : analyse‚Ä¶</span>
  </div>

  <div id="certfr-area">
    <span class="badge" style="background:#555">CERT‚ÄëFR : analyse‚Ä¶</span>
  </div>
</div>
<!-- Fin complement pour affichage comapgne et cert-fr -->

            <div class="matrix-card" style="margin-top:20px;">
                <h3>Matrices ATT&CK</h3>
                <div id="matrix-badges" style="margin:10px 0;"></div>
                <ul id="capec-list" style="font-size:0.9em; column-count: 2;"></ul>
            </div>
            
            <div id="atm-area"></div>
        </div>
    `;
   //ajout recherche campgn eet Cert-Ft
  checkMitreCampaigns(cve.id);
  checkCertFR(cve.id);

    // G√©n√©ration des boutons CWE pour le drill-down
    const cweArea = document.getElementById("cwe-area");
    cwes.forEach(c => {
        const btn = document.createElement("button");
        btn.textContent = "CWE-" + c;
        btn.className = "badge";
        btn.style.margin = "2px";
        btn.onclick = () => drill(c);
        cweArea.appendChild(btn);
    });

    if(cwes.length > 0) drill(cwes[0]);
}

async function drill(cweId) {
    const listElt = document.getElementById("capec-list");
    const tids = new Set();
    const capecsWithNames = []; // Pour le graphique
    
    const cweKey = CWE_DB[cweId] ? cweId : `CWE-${cweId}`;
    const cweData = CWE_DB[cweKey];
    const capecIds = cweData?.RelatedAttackPatterns || [];

    listElt.innerHTML = capecIds.length === 0 ? "<li>Aucun CAPEC li√©.</li>" : "";

    capecIds.forEach(id => {
        const cap = CAPEC_DB[id];
        if(cap) {
            capecsWithNames.push({ id: id, name: cap.name });
            const li = document.createElement("li");
            li.innerHTML = `<strong>CAPEC-${id}</strong>: ${cap.name}`;
            listElt.appendChild(li);

            // Extraction des techniques Txxxx
            const txt = JSON.stringify(cap);
            const matches = txt.match(/T\d{4}(\.\d{3})?/g);
            if(matches) matches.forEach(t => tids.add(t));
        }
    });

    const finalTids = Array.from(tids);
    
    // Mise √† jour des compteurs de matrices (Badges)
    updateMatrixCounts(finalTids);
    
    // Rendu du graphique visuel
    drawPivotGraph(cweId, capecsWithNames, finalTids);
    
    // Rendu ATM
    renderATM(finalTids);
}

function updateBadges(tids) {
    const area = document.getElementById("matrix-badges");
    if(!area) return;
    
    const counts = { enterprise: 0, mobile: 0, ics: 0 };
    tids.forEach(t => {
        const info = MITRE_INDEX[t];
        if(info && info.m) {
            info.m.forEach(m => counts[m]++);
        } else {
            // Si on ne trouve pas dans l'index, on log pour debugger
            console.warn(`Technique ${t} non trouv√©e dans mitre_map_index.json`);
            counts.enterprise++; 
        }
    });

    area.innerHTML = `
        <span class="badge" style="background:#e74c3c">Ent: ${counts.enterprise}</span>
        <span class="badge" style="background:#3498db">Mob: ${counts.mobile}</span>
        <span class="badge" style="background:#f1c40f; color:#000">ICS: ${counts.ics}</span>
    `;
}
function updateMatrixCounts(tids) {
    const area = document.getElementById("matrix-badges");
    const counts = { enterprise: 0, mobile: 0, ics: 0 };
    
    tids.forEach(t => {
        const info = MITRE_INDEX[t];
        if(info && info.m) {
            info.m.forEach(m => {
                if(m.includes("enterprise")) counts.enterprise++;
                if(m.includes("mobile")) counts.mobile++;
                if(m.includes("ics")) counts.ics++;
            });
        }
    });

    area.innerHTML = `
        <span class="badge" style="background:#e74c3c; padding:5px 10px; margin-right:5px;">Enterprise: ${counts.enterprise}</span>
        <span class="badge" style="background:#3498db; padding:5px 10px; margin-right:5px;">Mobile: ${counts.mobile}</span>
        <span class="badge" style="background:#f1c40f; color:black; padding:5px 10px;">ICS: ${counts.ics}</span>
    `;
}
function renderATM(tids) {
    const area = document.getElementById("atm-area");
    if(!area) return;
    
    const hits = ATM_DB.filter(a => a.techniques.some(t => tids.includes(t)));
    area.innerHTML = `<h3>ATM Mapping (${hits.length} correspondances)</h3>`;
    
    if(hits.length === 0) {
        area.innerHTML += "<p>Aucune technique ATM ne correspond √† ces TTPs.</p>";
        return;
    }

    hits.forEach(h => {
        area.innerHTML += `
            <div class="card" style="border-left:4px solid #2ecc71; margin-bottom:5px; padding:10px; background:rgba(46,204,113,0.1)">
                <strong>${h.id} - ${h.name}</strong> (Tactique: ${h.tactic})
            </div>`;
    });
}
function drawPivotGraph(cweId, capecs, tids) {
    const svg = document.getElementById("pivotSvg");
    if(!svg) return;
    svg.innerHTML = ""; // On nettoie

    const width = svg.clientWidth;
    const xStep = width / 4;
    
    // 1. Dessiner la CWE (√† gauche)
    const cweNode = createNode(50, 150, `CWE-${cweId}`, "#3498db");
    svg.appendChild(cweNode);

    // 2. Dessiner les CAPEC (au milieu) - Max 5 pour la lisibilit√©
    capecs.slice(0, 5).forEach((cap, i) => {
        const y = 50 + (i * 60);
        const capNode = createNode(xStep * 1.5, y, `CAPEC-${cap.id}`, "#f1c40f");
        svg.appendChild(capNode);
        svg.appendChild(createLine(80, 150, xStep * 1.5, y));
    });

    // 3. Dessiner les Techniques ATT&CK (√† droite) - Max 8
    tids.slice(0, 8).forEach((t, i) => {
        const y = 30 + (i * 40);
        const tNode = createNode(xStep * 3, y, t, "#e74c3c");
        svg.appendChild(tNode);
        
        // On lie chaque technique au premier CAPEC pour le visuel (simplifi√©)
        if(capecs.length > 0) {
            svg.appendChild(createLine(xStep * 1.5 + 30, 50, xStep * 3, y, "#444"));
        }
    });
}

// Helpers pour le SVG
function createNode(x, y, text, color) {
    const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
    const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
    rect.setAttribute("x", x); rect.setAttribute("y", y - 15);
    rect.setAttribute("width", "100"); rect.setAttribute("height", "30");
    rect.setAttribute("rx", "5"); rect.setAttribute("fill", color);
    
    const txt = document.createElementNS("http://www.w3.org/2000/svg", "text");
    txt.setAttribute("x", x + 10); txt.setAttribute("y", y + 5);
    txt.setAttribute("fill", "#000"); txt.setAttribute("font-size", "12");
    txt.textContent = text;
    
    g.appendChild(rect); g.appendChild(txt);
    return g;
}

function createLine(x1, y1, x2, y2, color="#666") {
    const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
    line.setAttribute("x1", x1); line.setAttribute("y1", y1);
    line.setAttribute("x2", x2); line.setAttribute("y2", y2);
    line.setAttribute("stroke", color); line.setAttribute("stroke-width", "1");
    return line;
}
  
document.getElementById("searchBtn").onclick = searchCVE;
</script>
</body>
</html>
