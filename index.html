<!doctype html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>X-Force Analyser | Visual Multi-Matrix Pivot</title>
    <style>
        :root {
            --bg: #0d1117; --card: #161b22; --txt: #c9d1d9; --muted: #8b949e;
            --accent: #58a6ff; --ent: #7aa2ff; --mob: #d299ff; --ics: #39d353;
            --bad: #f85149; --ok: #238636; --line: #30363d; --mono: ui-monospace, SFMono-Regular, monospace;
        }
        body { margin: 0; font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--txt); }
        header { border-bottom: 1px solid var(--line); padding: 1.5rem; text-align: center; background: #161b22; }
        .container { max-width: 1200px; margin: auto; padding: 20px; }
        
        .search-box { display: flex; gap: 10px; background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid var(--line); }
        input { flex: 1; background: #0d1117; border: 1px solid var(--line); color: white; padding: 12px; border-radius: 6px; font-family: var(--mono); }
        button { background: var(--ok); color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        
        .card { background: var(--card); border: 1px solid var(--line); border-radius: 10px; padding: 20px; margin-top: 20px; }
        
        /* Visual Graph Area */
        #canvas-container { width: 100%; overflow-x: auto; background: #07090d; border-radius: 10px; border: 1px solid var(--line); margin-top: 20px; position: relative; }
        svg { display: block; margin: auto; }
        .node-text { font-size: 11px; fill: var(--txt); font-family: var(--mono); pointer-events: none; }
        .link { fill: none; stroke: var(--line); stroke-width: 1.5; opacity: 0.4; transition: 0.3s; }
        .link.active { stroke: var(--accent); opacity: 1; stroke-width: 2; }

        .matrix-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 20px; }
        .m-header { font-weight: 800; font-size: 12px; padding: 5px; border-radius: 4px; text-align: center; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.1); }
        .ent-h { color: var(--ent); background: rgba(122, 162, 255, 0.1); border-color: var(--ent); }
        .mob-h { color: var(--mob); background: rgba(210, 153, 255, 0.1); border-color: var(--mob); }
        .ics-h { color: var(--ics); background: rgba(57, 211, 83, 0.1); border-color: var(--ics); }
        
        .tech-item { background: #0d1117; padding: 10px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid transparent; font-size: 12px; }
        .ent-l { border-left-color: var(--ent); }
        .mob-l { border-left-color: var(--mob); }
        .ics-l { border-left-color: var(--ics); }

        .tag { font-size: 9px; background: #21262d; border: 1px solid var(--line); padding: 1px 4px; border-radius: 3px; color: var(--muted); margin-right: 2px; }
        .pill { display: inline-block; padding: 5px 12px; border-radius: 20px; background: #21262d; border: 1px solid var(--line); font-size: 13px; margin: 4px; cursor: pointer; }
        #log { font-family: var(--mono); font-size: 11px; color: var(--muted); padding: 10px; }
    </style>
</head>
<body>

<header>
    <h1>X-Force Graph Analyser</h1>
    <p style="color:var(--muted)">Visualisation du chaînage : CVE → CWE → ATT&CK Matrices</p>
</header>

<div class="container">
    <div class="search-box">
        <input id="cveInput" type="text" placeholder="CVE-2023-34362" value="CVE-2023-34362">
        <button id="searchBtn">Analyser & Tracer</button>
    </div>

    <div id="results"></div>

    <div id="canvas-container" style="display:none">
        <svg id="pivotGraph" width="1100" height="400"></svg>
    </div>

    <div id="drill-zone"></div>
    <div id="log">Système prêt.</div>
</div>

<script>
const BUILD_PATH = "./build/mitre_map_index.json";
const DATA_PATH = "./data";
const NVD_API = "https://services.nvd.nist.gov/rest/json/cves/2.0";

let MITRE_INDEX = null, CWE_DB = null, CAPEC_DB = null;

async function initBases() {
    if (MITRE_INDEX) return;
    const [m, cwe, capec] = await Promise.all([
        fetch(BUILD_PATH).then(r => r.json()),
        fetch(`${DATA_PATH}/cwe_db.json`).then(r => r.json()),
        fetch(`${DATA_PATH}/capec_db.json`).then(r => r.json())
    ]);
    MITRE_INDEX = m; CWE_DB = cwe; CAPEC_DB = capec;
}

function getTechniquesFromCWE(cweId) {
    const entry = CWE_DB[cweId];
    if (!entry) return [];
    const tids = new Set();
    (entry.RelatedAttackPatterns || []).forEach(capecId => {
        const capec = CAPEC_DB[capecId];
        if (capec?.techniques) {
            const matches = capec.techniques.match(/T\d{4}(\.\d{3})?/g);
            if (matches) matches.forEach(t => tids.add(t));
        }
    });
    return Array.from(tids);
}

/* ================= MOTEUR GRAPHIQUE SVG ================= */
function drawGraph(cveId, cwes) {
    const svg = document.getElementById("pivotGraph");
    const container = document.getElementById("canvas-container");
    container.style.display = "block";
    svg.innerHTML = ''; // Clear

    const cols = { cve: 50, cwe: 300, matrix: 600, tech: 900 };
    const getY = (index, total, height = 400) => (height / (total + 1)) * (index + 1);

    // 1. Dessiner le Node CVE
    drawNode(svg, cols.cve, 200, cveId, "var(--accent)");

    // 2. Dessiner les CWE et liens vers CVE
    cwes.forEach((cwe, i) => {
        const y = getY(i, cwes.length);
        drawNode(svg, cols.cwe, y, "CWE-"+cwe, "var(--txt)");
        drawLink(svg, cols.cve, 200, cols.cwe, y);

        // 3. Pour chaque CWE, chercher les techniques
        const tids = getTechniquesFromCWE(cwe);
        const matrixImpact = { enterprise: false, mobile: false, ics: false };
        
        tids.forEach(tid => {
            const info = MITRE_INDEX[tid];
            if(info) info.m.forEach(m => matrixImpact[m] = true);
        });

        // Liens vers colonnes Matrices
        if (matrixImpact.enterprise) drawLink(svg, cols.cwe, y, cols.matrix, 100, "var(--ent)");
        if (matrixImpact.mobile) drawLink(svg, cols.cwe, y, cols.matrix, 200, "var(--mob)");
        if (matrixImpact.ics) drawLink(svg, cols.cwe, y, cols.matrix, 300, "var(--ics)");
    });

    // Node des Matrices
    drawNode(svg, cols.matrix, 100, "ENTERPRISE", "var(--ent)");
    drawNode(svg, cols.matrix, 200, "MOBILE", "var(--mob)");
    drawNode(svg, cols.matrix, 300, "ICS", "var(--ics)");
}

function drawNode(svg, x, y, text, color) {
    const group = document.createElementNS("http://www.w3.org/2000/svg", "g");
    const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
    rect.setAttribute("x", x - 60); rect.setAttribute("y", y - 15);
    rect.setAttribute("width", 120); rect.setAttribute("height", 30);
    rect.setAttribute("rx", 5); rect.setAttribute("fill", "#161b22");
    rect.setAttribute("stroke", color);
    
    const txt = document.createElementNS("http://www.w3.org/2000/svg", "text");
    txt.setAttribute("x", x); txt.setAttribute("y", y + 5);
    txt.setAttribute("text-anchor", "middle"); txt.setAttribute("class", "node-text");
    txt.textContent = text;
    
    group.appendChild(rect); group.appendChild(txt);
    svg.appendChild(group);
}

function drawLink(svg, x1, y1, x2, y2, color = "var(--line)") {
    const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
    const d = `M ${x1+60} ${y1} C ${(x1+x2)/2} ${y1}, ${(x1+x2)/2} ${y2}, ${x2-60} ${y2}`;
    path.setAttribute("d", d);
    path.setAttribute("class", "link");
    path.setAttribute("stroke", color);
    svg.appendChild(path);
}

/* ================= RECHERCHE & DRILLDOWN ================= */
async function searchCVE() {
    const id = document.getElementById("cveInput").value.trim().toUpperCase();
    try {
        await initBases();
        const resp = await fetch(`${NVD_API}?cveId=${id}`);
        const data = await resp.json();
        const cve = data.vulnerabilities?.[0]?.cve;
        const cwes = (cve.weaknesses || []).flatMap(w => w.description || [])
                        .map(d => d.value.match(/CWE-(\d+)/)?.[1]).filter(Boolean);

        drawGraph(id, cwes);
        renderDetails(cve, cwes);
    } catch (e) { console.error(e); }
}

function renderDetails(cve, cwes) {
    const res = document.getElementById("results");
    res.innerHTML = `<div class="card"><h2>${cve.id}</h2><p>${cwes.map(c => `<span class="pill" onclick="renderMatrix('${c}')">CWE-${c}</span>`).join('')}</p></div>`;
}

function renderMatrix(cweId) {
    const zone = document.getElementById("drill-zone");
    const tids = getTechniquesFromCWE(cweId);
    const mKeys = ['enterprise', 'mobile', 'ics'];
    
    let html = `<div class="matrix-grid">`;
    mKeys.forEach(m => {
        const found = tids.filter(t => MITRE_INDEX[t]?.m.includes(m));
        html += `<div class="card"><div class="m-header ${m.substring(0,3)}-h">${m.toUpperCase()}</div>`;
        html += found.map(t => `<div class="tech-item ${m.substring(0,3)}-l"><b>${t}</b> - ${MITRE_INDEX[t].n}</div>`).join('') || '<div class="muted">N/A</div>';
        html += `</div>`;
    });
    zone.innerHTML = html + `</div>`;
}

document.getElementById("searchBtn").onclick = searchCVE;
</script>
</body>
</html>
