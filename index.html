<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>X-Force Analyser – NVD → CWE → CAPEC → ATT&CK → ATM</title>

<style>
:root{
  --bg:#0b1020; --card:#121a33; --txt:#e9ecff; --muted:#aab3da;
  --accent:#7aa2ff; --ok:#36d399; --warn:#fbbf24; --bad:#f87171; --line:#26325f;
  --ent:#7aa2ff; --mob:#d299ff; --ics:#39d353;
  --mono: ui-monospace, Menlo, Consolas, monospace;
}
body{margin:0;font-family:system-ui,sans-serif;background:linear-gradient(160deg,#070a15,var(--bg));color:var(--txt);font-size:14px;}
header,main,.monitor{max-width:1300px;margin:auto;padding:18px}
.card{background:rgba(18,26,51,.95);border:1px solid var(--line);border-radius:14px;padding:18px;margin-top:14px}
.row{display:flex;gap:10px;align-items:center}
input,button{padding:12px;border-radius:10px;border:1px solid var(--line);background:#0a0f22;color:var(--txt)}
button{cursor:pointer;font-weight:bold;background:var(--accent);color:#000;border:none}
.badge{padding:4px 10px;border-radius:6px;font-weight:bold;font-size:11px;text-transform:uppercase;border:1px solid transparent}
.sev-CRITICAL{background:rgba(248,113,113,0.2);color:var(--bad);border-color:var(--bad)}
.kev-active{background:var(--bad);color:white;animation:pulse 2s infinite}
@keyframes pulse { 0% {opacity:1} 50% {opacity:0.7} 100% {opacity:1} }
.grid-3{display:grid;grid-template-columns:repeat(auto-fit, minmax(300px, 1fr));gap:15px;margin-top:15px}
.matrix-card{border-top:4px solid var(--accent);padding:10px;background:rgba(255,255,255,0.03);border-radius:8px}
#pivotSvg{width:100%;height:500px;background:rgba(0,0,0,0.2);border-radius:10px;border:1px solid var(--line);margin-top:20px}
.log{font-family:var(--mono);font-size:12px;max-height:150px;overflow:auto;background:#000;padding:10px;border-radius:8px}
</style>
</head>

<body>
<header>
  <h1>CVE Analyser By Katell2978</h1>
  <p class="muted">Mapping complet : NVD (CVE) → CWE → CAPEC → ATT&CK (Matrices) → ATM Perso</p>
</header>

<main>
  <div class="card">
    <div class="row">
      <input id="cveInput" class="mono" style="flex:1" placeholder="CVE-2023-34362" value="CVE-2023-34362" />
      <button id="searchBtn">Lancer l'Analyse Totale</button>
      <span id="status" class="muted">Prêt.</span>
    </div>
  </div>

  <div id="results"></div>
</main>

<div class="monitor">
  <div class="card">
    <b>Logs d'exécution</b>
    <div id="log" class="log"></div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const APIS = {
    nvd: "https://services.nvd.nist.gov/rest/json/cves/2.0?cveId=",
    kev: "build/kev.json"
};

let MITRE_INDEX, CWE_DB, CAPEC_DB, ATM_DB;

/* ================= UTILS ================= */
function log(msg, color="var(--txt)"){
    const l=document.getElementById("log");
    if(!l) return;
    l.innerHTML+=`<div style="color:${color}">> ${msg}</div>`;
    l.scrollTop=l.scrollHeight;
}

/* ================= CHARGEMENT ================= */
async function loadAllBases() {
    if (MITRE_INDEX) return;
    log("Chargement des référentiels...");
    try {
        const [m, cwe, capec, atmText] = await Promise.all([
            fetch('build/mitre_map_index.json').then(r => r.json()),
            fetch('data/cwe_db.json').then(r => r.json()),
            fetch('data/capec_db.json').then(r => r.json()),
            fetch('data/ATM-matrix-TTP.csv').then(r => r.text())
        ]);
        MITRE_INDEX = m; CWE_DB = cwe; CAPEC_DB = capec;
        ATM_DB = parseATM(atmText);
        log("Bases chargées avec succès ✅", "var(--ok)");
    } catch (e) {
        log("Erreur chargement: " + e.message, "var(--bad)");
    }
}

function parseATM(csv) {
    if(!csv) return [];
    return csv.split(/\r?\n/).slice(1).filter(l => l.trim()).map(line => {
        const c = line.split(";").map(x => x.trim());
        return { tactic: c[0], id: c[1], name: c[2], techniques: (c[3]||"").split(",").filter(Boolean) };
    });
}

/* ================= ANALYSE ================= */
async function searchCVE() {
    const id = document.getElementById('cveInput').value.trim().toUpperCase();
    if(!id.startsWith("CVE-")) return alert("Format CVE invalide");
    
    document.getElementById("status").textContent = "Analyse en cours...";
    await loadAllBases();

    try {
        const [nvdRes, kevRes] = await Promise.all([
            fetch(APIS.nvd + id).then(r => r.json()),
            fetch(APIS.kev).then(r => r.json()).catch(() => ({ vulnerabilities: [] }))
        ]);

        const cve = nvdRes.vulnerabilities?.[0]?.cve;
        if(!cve) throw new Error("CVE non trouvée au NVD");
        
        const isKev = kevRes.vulnerabilities.some(v => v.cveID === id);
        renderUI(cve, isKev);
    } catch (e) {
        log("Erreur: " + e.message, "var(--bad)");
    }
}

function renderUI(cve, isKev) {
    const metrics = cve.metrics?.cvssMetricV31?.[0] || cve.metrics?.cvssMetricV30?.[0];
    const score = metrics?.cvssData?.baseScore || "N/A";
    const sev = metrics?.cvssData?.baseSeverity || "UNKNOWN";
    const cwes = (cve.weaknesses || []).flatMap(w => w.description.map(d => d.value.split('-')[1])).filter(Boolean);

    document.getElementById("results").innerHTML = `
        <div class="card">
            <h2>${cve.id} ${isKev ? '<span class="badge kev-active">⚠ KEV</span>' : ''}</h2>
            <div class="badge sev-${sev}">CVSS ${score}</div>
            <p>${cve.descriptions.find(d => d.lang === 'en')?.value || ""}</p>
            <div class="grid-3">
                <div class="matrix-card">
                    <b>CWE Détectées</b>
                    <div id="cwe-list"></div>
                </div>
                <div class="matrix-card" style="grid-column: span 2">
                    <b>Matrices ATT&CK</b>
                    <div id="matrix-badges">En attente...</div>
                </div>
            </div>
            <div id="drilldown-area"></div>
            <svg id="pivotSvg" style="width:100%; height:400px; border:1px solid var(--line); margin-top:15px;"></svg>
        </div>
    `;

    const cweList = document.getElementById("cwe-list");
    cwes.forEach(c => {
        const btn = document.createElement("button");
        btn.textContent = "CWE-" + c;
        btn.style = "margin:2px; cursor:pointer";
        btn.onclick = () => drill(c);
        cweList.appendChild(btn);
    });

    if(cwes.length > 0) drill(cwes[0]);
}

async function drill(cweId) {
    log(`Drill-down CWE-${cweId}`);
    const tids = new Set();
    const lookupId = cweId.startsWith('CWE-') ? cweId : `CWE-${cweId}`;
    const cleanId = cweId.replace('CWE-', '');
    const cweData = CWE_DB[lookupId] || CWE_DB[cleanId];
    
    const capecIds = cweData?.RelatedAttackPatterns || [];
    const capecs = [];

    capecIds.forEach(id => {
        const data = CAPEC_DB[id];
        if (data) {
            capecs.push({ id: id, name: data.name });
            const fullText = JSON.stringify(data);
            const matches = fullText.match(/T\d{4}(\.\d{3})?/g);
            if (matches) matches.forEach(t => tids.add(t));
        }
    });

    const listTids = Array.from(tids);
    updateMatrixCounts(listTids);
    renderATM(listTids);
    // drawPivot(cweId, capecs, listTids); // Optionnel si tu as la fonction drawPivot
}

function updateMatrixCounts(tids) {
    const area = document.getElementById("matrix-badges");
    if(!area) return;
    const counts = { enterprise: 0, mobile: 0, ics: 0 };
    tids.forEach(t => {
        const info = MITRE_INDEX[t];
        if(info && info.m) info.m.forEach(m => counts[m]++);
    });
    area.innerHTML = `
        <span class="badge">Enterprise: ${counts.enterprise}</span>
        <span class="badge">Mobile: ${counts.mobile}</span>
        <span class="badge">ICS: ${counts.ics}</span>
    `;
}

function renderATM(tids) {
    const area = document.getElementById("drilldown-area");
    if(!ATM_DB) return;
    const hits = ATM_DB.filter(a => a.techniques.some(t => tids.includes(t)));
    area.innerHTML = `<h4>ATM Mapping (${hits.length} hits)</h4>`;
    hits.forEach(h => {
        area.innerHTML += `<div class="card">${h.id} - ${h.name}</div>`;
    });
}

document.getElementById("searchBtn").onclick = searchCVE;
</script>
</body>
</html>
