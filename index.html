<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CVE → CWE → CAPEC → ATT&CK → ATM</title>

<style>
:root{
  --bg:#0b1020; --card:#121a33; --txt:#e9ecff; --muted:#aab3da;
  --accent:#7aa2ff; --ok:#36d399; --warn:#fbbf24; --bad:#f87171; --line:#26325f;
  --mono: ui-monospace, Menlo, Consolas, monospace;
  --sans: system-ui, Segoe UI, Roboto, Arial, sans-serif;
}
body{margin:0;font-family:var(--sans);background:linear-gradient(160deg,#070a15,var(--bg));color:var(--txt);}
header,main,.monitor{max-width:1100px;margin:auto;padding:18px}
h1{margin:0 0 6px;font-size:22px}
.card{background:rgba(18,26,51,.95);border:1px solid var(--line);border-radius:14px;padding:14px;margin-top:14px}
.row{display:flex;gap:10px;flex-wrap:wrap}
input,select,button{
  padding:10px;border-radius:10px;border:1px solid var(--line);
  background:#0a0f22;color:var(--txt)
}
button{cursor:pointer}
button:hover{border-color:#3b4aa0}
.mono{font-family:var(--mono)}
.muted{color:var(--muted)}
.pill{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:3px 8px;font-size:12px;margin:2px}
.tag{border:1px solid var(--line);border-radius:999px;padding:2px 6px;font-size:11px;margin-left:4px}
.spinner{width:12px;height:12px;border:2px solid #fff3;border-top-color:#fff;border-radius:50%;display:inline-block;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.log{font-family:var(--mono);font-size:12px;max-height:220px;overflow:auto}
.log .ok{color:var(--ok)} .log .warn{color:var(--warn)} .log .bad{color:var(--bad)}
#pivotSvg{width:100%;height:420px}
</style>
</head>

<body>

<header>
<h1>CVE → CWE → CAPEC → ATT&CK → ATM</h1>
<p class="muted">Analyse vulnérabilité → menace → détection automotive</p>
</header>

<main>
<div class="card">
  <div class="row">
    <select id="mode">
      <option value="cve">Recherche CVE</option>
      <option value="cpe">Recherche CPE</option>
    </select>
    <input id="queryInput" value="CVE-2023-48010"/>
    <button id="searchBtn">Rechercher</button>
  </div>
  <div id="status" class="muted">Prêt.</div>
</div>

<div id="results"></div>
</main>

<div class="monitor">
<div class="card">
<b>Moniteur</b>
<div id="log" class="log"></div>
</div>
</div>

<script>
/* =================== CONFIG =================== */
const NVD = "https://services.nvd.nist.gov/rest/json/cves/2.0";
const DATA = "./data";
const CPE_THRESHOLD = 200;

/* =================== UTILS =================== */
function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g,c=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}
function log(msg,cls=""){
  const l=document.getElementById("log");
  l.innerHTML+=`<div class="${cls}">${escapeHtml(msg)}</div>`;
  l.scrollTop=l.scrollHeight;
}
function setStatus(t){document.getElementById("status").textContent=t}
function last12Months(){
  const end=new Date();
  const start=new Date();
  start.setMonth(start.getMonth()-12);
  return {
    start: start.toISOString().split(".")[0]+"Z",
    end: end.toISOString().split(".")[0]+"Z"
  };
}
function isValidCve(x){return /^CVE-\d{4}-\d{4,}$/i.test(x)}
function isLikelyCpe(x){return /^cpe:2\.3:/i.test(x)}

/* =================== DATA LOAD =================== */
let CWE=null,CAPEC=null,TECH=null,ATM=null;

async function loadBases(){
  if(CWE) return;
  [CWE,CAPEC,TECH]=await Promise.all([
    fetch(`${DATA}/cwe_db.json`).then(r=>r.json()),
    fetch(`${DATA}/capec_db.json`).then(r=>r.json()),
    fetch(`${DATA}/techniques_db.json`).then(r=>r.json())
  ]);
}
async function loadATM(){
  if(ATM) return ATM;
  const txt=await fetch(`${DATA}/ATM-matrix-TTP.csv`).then(r=>r.text());
  ATM=txt.split(/\r?\n/).slice(1).filter(Boolean).map(l=>{
    const c=l.split(";").map(x=>x.trim());
    return{
      tactic:c[0],atm:c[1],label:c[2],
      ent:(c[3]||"").split(",").filter(Boolean),
      mob:(c[4]||"").split(",").filter(Boolean),
      det:(c[5]||"").split(",").filter(Boolean),
      dc:(c[6]||"").match(/DC\d{4}/g)||[],
      on:c[12]==="Y",off:c[13]==="Y",rmq:c[14]||""
    };
  });
  return ATM;
}

/* =================== CWE → CAPEC → ATT&CK =================== */
function extractTech(tax){
  const s=new Set();
  tax?.split("NAME:ATTACK:ENTRY ").slice(1).forEach(p=>{
    const m=p.match(/:(\d{4}(?:\.\d{3})?)/);
    if(m) s.add("T"+m[1]);
  });
  return [...s];
}
async function computeFromCWE(cwe){
  await loadBases();
  const capecs=(CWE[cwe]?.RelatedAttackPatterns||[]).map(id=>CAPEC[id]).filter(Boolean);
  const techs=new Set();
  capecs.forEach(c=>extractTech(c.techniques).forEach(t=>techs.add(t)));
  return {
    capecs,
    techniques:[...techs].map(t=>({tid:t,url:`https://attack.mitre.org/techniques/${t}/`}))
  };
}

/* =================== RENDER =================== */
function renderCVE(cve){
  const div=document.getElementById("results");
  const cwes=(cve.weaknesses||[]).flatMap(w=>w.description||[])
    .map(d=>d.value.match(/CWE-(\d+)/)?.[1]).filter(Boolean);

  div.innerHTML=`
<div class="card">
<h2>${cve.id}</h2>
<p>${escapeHtml(cve.descriptions?.[0]?.value||"")}</p>
<div>${cwes.map(c=>`<span class="pill"><button onclick="drill('${c}')">CWE-${c}</button></span>`).join("")}</div>
<div id="drill" class="card muted">Clique sur une CWE</div>
</div>`;
}

async function drill(cwe){
  const d=document.getElementById("drill");
  d.innerHTML='<span class="spinner"></span> Calcul…';
  const {capecs,techniques}=await computeFromCWE(cwe);
  const atm=await loadATM();
  const tids=techniques.map(t=>t.tid);
  const hits=atm.filter(a=>a.ent.some(t=>tids.includes(t))||a.mob.some(t=>tids.includes(t)));

  d.innerHTML=`
<h3>ATT&CK</h3>
<ul>${techniques.map(t=>`<li><a href="${t.url}" target="_blank">${t.tid}</a></li>`).join("")}</ul>
<h3>ATM / Détection</h3>
<ul>${hits.map(h=>`
<li><b>${h.atm}</b> – ${escapeHtml(h.label)}
${h.on?'<span class="tag">Onboard</span>':''}
${h.off?'<span class="tag">Offboard</span>':''}
<div class="muted">DET:${h.det.join(",")||"—"} | DC:${h.dc.join(",")||"—"}</div>
</li>`).join("")}</ul>
<svg id="pivotSvg"></svg>`;
}

/* =================== SEARCH =================== */
async function searchCVE(id){
  if(!isValidCve(id)) return alert("CVE invalide");
  setStatus("Recherche CVE…");
  const j=await fetch(`${NVD}?cveId=${id}`).then(r=>r.json());
  const cve=j.vulnerabilities?.[0]?.cve;
  if(cve) renderCVE(cve);
}

async function searchCPE(cpe){
  if(!isLikelyCpe(cpe)) return alert("CPE invalide");
  setStatus("Recherche CPE…");

  const probe=await fetch(`${NVD}?cpeName=${encodeURIComponent(cpe)}&resultsPerPage=1`).then(r=>r.json());
  const total=probe.totalResults||0;

  let url;
  if(total>CPE_THRESHOLD){
    const w=last12Months();
    log(`Filtrage 12 mois (${total} CVE)`, "warn");
    url=`${NVD}?cpeName=${encodeURIComponent(cpe)}&pubStartDate=${w.start}&pubEndDate=${w.end}&resultsPerPage=50`;
  }else{
    url=`${NVD}?cpeName=${encodeURIComponent(cpe)}&resultsPerPage=50`;
  }

  const j=await fetch(url).then(r=>r.json());
  document.getElementById("results").innerHTML=
    `<div class="card"><ul>${j.vulnerabilities.map(v=>`<li><a href="#" onclick="searchCVE('${v.cve.id}')">${v.cve.id}</a></li>`).join("")}</ul></div>`;
}

/* =================== UI =================== */
document.getElementById("searchBtn").onclick=()=>{
  const m=document.getElementById("mode").value;
  const q=document.getElementById("queryInput").value.trim();
  m==="cve"?searchCVE(q):searchCPE(q);
};

log("Page chargée ✅");
</script>

</body>
</html>
