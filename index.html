<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>X-Force Analyser ‚Äì NVD ‚Üí CWE ‚Üí CAPEC ‚Üí ATT&CK ‚Üí ATM</title>

<style>
:root{
  --bg:#0b1020; --card:#121a33; --txt:#e9ecff; --muted:#aab3da;
  --accent:#7aa2ff; --ok:#36d399; --warn:#fbbf24; --bad:#f87171; --line:#26325f;
  --ent:#7aa2ff; --mob:#d299ff; --ics:#39d353;
  --mono: ui-monospace, Menlo, Consolas, monospace;
}
body{margin:0;font-family:system-ui,sans-serif;background:linear-gradient(160deg,#070a15,var(--bg));color:var(--txt);font-size:14px;}
header,main,.monitor{max-width:1300px;margin:auto;padding:18px}
.card{background:rgba(18,26,51,.95);border:1px solid var(--line);border-radius:14px;padding:18px;margin-top:14px}
.row{display:flex;gap:10px;align-items:center}
input,button{padding:12px;border-radius:10px;border:1px solid var(--line);background:#0a0f22;color:var(--txt)}
button{cursor:pointer;font-weight:bold;background:var(--accent);color:#000;border:none}
.badge{padding:4px 10px;border-radius:6px;font-weight:bold;font-size:11px;text-transform:uppercase;border:1px solid transparent}
.sev-CRITICAL{background:rgba(248,113,113,0.2);color:var(--bad);border-color:var(--bad)}
.kev-active{background:var(--bad);color:white;animation:pulse 2s infinite}
@keyframes pulse { 0% {opacity:1} 50% {opacity:0.7} 100% {opacity:1} }
.grid-3{display:grid;grid-template-columns:repeat(auto-fit, minmax(300px, 1fr));gap:15px;margin-top:15px}
.matrix-card{border-top:4px solid var(--accent);padding:10px;background:rgba(255,255,255,0.03);border-radius:8px}
#pivotSvg{width:100%;height:500px;background:rgba(0,0,0,0.2);border-radius:10px;border:1px solid var(--line);margin-top:20px}
.log{font-family:var(--mono);font-size:12px;max-height:150px;overflow:auto;background:#000;padding:10px;border-radius:8px}
</style>
</head>

<body>
<header>
  <h1>CVE Analyser By Katell2978</h1>
  <p class="muted">Mapping complet : NVD (CVE) ‚Üí CWE ‚Üí CAPEC ‚Üí ATT&CK (Matrices) ‚Üí ATM Perso</p>
</header>

<main>
  <div class="card">
    <div class="row">
      <input id="cveInput" class="mono" style="flex:1" placeholder="CVE-2023-34362" value="CVE-2023-34362" />
      <button id="searchBtn">Lancer l'Analyse Totale</button>
      <span id="status" class="muted">Pr√™t.</span>
    </div>
  </div>

  <div id="results"></div>
</main>

<div class="monitor">
  <div class="card">
    <b>Logs d'ex√©cution</b>
    <div id="log" class="log"></div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const APIS = {
    nvd: "https://services.nvd.nist.gov/rest/json/cves/2.0?cveId=",
    kev: "build/kev.json"
};

let MITRE_INDEX = {}, CWE_DB = {}, CAPEC_DB = {}, ATM_DB = [];

/* ================= CHARGEMENT ================= */
async function loadAllBases() {
    if (Object.keys(CWE_DB).length > 0) return;
    console.log("üöÄ Tentative de chargement des bases...");
    try {
        const [m, cwe, capec, atmText] = await Promise.all([
            fetch('build/mitre_map_index.json').then(r => r.json()).catch(e => { console.error("Index MITRE manquant"); return {}; }),
            fetch('data/cwe_db.json').then(r => r.json()),
            fetch('data/capec_db.json').then(r => r.json()),
            fetch('data/ATM-matrix-TTP.csv').then(r => r.text()).catch(() => "")
        ]);
        
        MITRE_INDEX = m; CWE_DB = cwe; CAPEC_DB = capec;
        ATM_DB = parseATM(atmText);
        
        console.log("‚úÖ Bases charg√©es !", {
            mitre: Object.keys(MITRE_INDEX).length, 
            cwe: Object.keys(CWE_DB).length,
            capec: Object.keys(CAPEC_DB).length,
            atm: ATM_DB.length
        });
    } catch (e) {
        console.error("‚ùå Erreur critique lors du chargement:", e);
    }
}

function parseATM(csv) {
    if(!csv || csv.length < 10) return [];
    return csv.split(/\r?\n/).slice(1).filter(l => l.trim()).map(line => {
        const c = line.split(";").map(x => x.trim());
        return { tactic: c[0], id: c[1], name: c[2], techniques: (c[3]||"").split(",").map(t=>t.trim()).filter(Boolean) };
    });
}

/* ================= ANALYSE ================= */
async function searchCVE() {
    const id = document.getElementById('cveInput').value.trim().toUpperCase();
    if(!id) return;
    
    document.getElementById("status").textContent = "Analyse en cours...";
    await loadAllBases();

    try {
        const nvdRes = await fetch(APIS.nvd + id).then(r => r.json());
        const kevRes = await fetch(APIS.kev).then(r => r.json()).catch(() => ({ vulnerabilities: [] }));
        
        const cve = nvdRes.vulnerabilities?.[0]?.cve;
        if(!cve) {
            document.getElementById("status").textContent = "CVE non trouv√©e.";
            return;
        }
        
        const isKev = (kevRes.vulnerabilities || []).some(v => v.cveID === id);
        document.getElementById("status").textContent = "Analyse termin√©e.";
        renderUI(cve, isKev);
    } catch (e) { 
        console.error(e);
        document.getElementById("status").textContent = "Erreur de recherche.";
    }
}

function renderUI(cve, isKev) {
    const cwes = (cve.weaknesses || []).flatMap(w => w.description.map(d => d.value.split('-')[1])).filter(Boolean);
    const desc = cve.descriptions.find(d => d.lang === 'en')?.value || "Pas de description.";

    document.getElementById("results").innerHTML = `
        <div class="card">
            <h2>${cve.id} ${isKev ? '<span class="badge kev-active">‚ö†Ô∏è KEV</span>' : ''}</h2>
            <p style="font-style:italic; margin-bottom:15px;">${desc}</p>
            
            <div class="grid-3" style="display:grid; grid-template-columns: 1fr 2fr; gap:20px;">
                <div class="matrix-card">
                    <h3>CWE D√©tect√©es</h3>
                    <div id="cwe-area"></div>
                </div>
                <div class="matrix-card">
                    <h3>Matrices ATT&CK</h3>
                    <div id="matrix-badges" style="margin-bottom:10px;"></div>
                    <ul id="capec-list" style="font-size:0.9em; max-height:200px; overflow-y:auto;"></ul>
                </div>
            </div>
            
            <div id="atm-area" style="margin-top:20px;"></div>
            <div id="graph-area" style="margin-top:20px;">
                 <h3>Visualisation Pivot</h3>
                 <svg id="pivotSvg" style="width:100%; height:300px; background:#1a1a1a; border-radius:8px;"></svg>
            </div>
        </div>
    `;

    cwes.forEach(c => {
        const btn = document.createElement("button");
        btn.textContent = "CWE-" + c;
        btn.className = "badge";
        btn.style.cursor = "pointer";
        btn.onclick = () => drill(c);
        document.getElementById("cwe-area").appendChild(btn);
    });

    if(cwes.length > 0) drill(cwes[0]);
}

async function drill(cweId) {
    console.log(`üîç Exploration de CWE-${cweId}`);
    const listElt = document.getElementById("capec-list");
    const tids = new Set();
    
    const cweKey = CWE_DB[cweId] ? cweId : `CWE-${cweId}`;
    const cweData = CWE_DB[cweKey];
    const capecIds = cweData?.RelatedAttackPatterns || [];

    listElt.innerHTML = capecIds.length === 0 ? "<li>Aucun CAPEC li√©.</li>" : "";

    capecIds.forEach(id => {
        const cap = CAPEC_DB[id];
        if(cap) {
            const li = document.createElement("li");
            li.innerHTML = `<strong>CAPEC-${id}</strong>: ${cap.name}`;
            listElt.appendChild(li);

            // Extraction des techniques (Txxxx)
            const txt = JSON.stringify(cap);
            const matches = txt.match(/T\d{4}(\.\d{3})?/g);
            if(matches) matches.forEach(t => tids.add(t));
        }
    });

    const finalTids = Array.from(tids);
    console.log(`üéØ Techniques trouv√©es : ${finalTids.length}`, finalTids);
    
    updateBadges(finalTids);
    renderATM(finalTids);
    if(window.drawPivot) drawPivot(cweId, capecIds, finalTids); // Si vous avez gard√© la fonction D3.js
}

function updateBadges(tids) {
    const area = document.getElementById("matrix-badges");
    if(!area) return;
    
    const counts = { enterprise: 0, mobile: 0, ics: 0 };
    tids.forEach(t => {
        const info = MITRE_INDEX[t];
        if(info && info.m) {
            info.m.forEach(m => counts[m]++);
        } else {
            // Si on ne trouve pas dans l'index, on log pour debugger
            console.warn(`Technique ${t} non trouv√©e dans mitre_map_index.json`);
            counts.enterprise++; 
        }
    });

    area.innerHTML = `
        <span class="badge" style="background:#e74c3c">Ent: ${counts.enterprise}</span>
        <span class="badge" style="background:#3498db">Mob: ${counts.mobile}</span>
        <span class="badge" style="background:#f1c40f; color:#000">ICS: ${counts.ics}</span>
    `;
}

function renderATM(tids) {
    const area = document.getElementById("atm-area");
    if(!area) return;
    
    const hits = ATM_DB.filter(a => a.techniques.some(t => tids.includes(t)));
    area.innerHTML = `<h3>ATM Mapping (${hits.length} correspondances)</h3>`;
    
    if(hits.length === 0) {
        area.innerHTML += "<p>Aucune technique ATM ne correspond √† ces TTPs.</p>";
        return;
    }

    hits.forEach(h => {
        area.innerHTML += `
            <div class="card" style="border-left:4px solid #2ecc71; margin-bottom:5px; padding:10px; background:rgba(46,204,113,0.1)">
                <strong>${h.id} - ${h.name}</strong> (Tactique: ${h.tactic})
            </div>`;
    });
}

document.getElementById("searchBtn").onclick = searchCVE;
</script>
</body>
</html>
