<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>X-Force Analyser – NVD → CWE → CAPEC → ATT&CK → ATM</title>

<style>
:root{
  --bg:#0b1020; --card:#121a33; --txt:#e9ecff; --muted:#aab3da;
  --accent:#7aa2ff; --ok:#36d399; --warn:#fbbf24; --bad:#f87171; --line:#26325f;
  --ent:#7aa2ff; --mob:#d299ff; --ics:#39d353;
  --mono: ui-monospace, Menlo, Consolas, monospace;
}
body{margin:0;font-family:system-ui,sans-serif;background:linear-gradient(160deg,#070a15,var(--bg));color:var(--txt);font-size:14px;}
header,main,.monitor{max-width:1300px;margin:auto;padding:18px}
.card{background:rgba(18,26,51,.95);border:1px solid var(--line);border-radius:14px;padding:18px;margin-top:14px}
.row{display:flex;gap:10px;align-items:center}
input,button{padding:12px;border-radius:10px;border:1px solid var(--line);background:#0a0f22;color:var(--txt)}
button{cursor:pointer;font-weight:bold;background:var(--accent);color:#000;border:none}
.badge{padding:4px 10px;border-radius:6px;font-weight:bold;font-size:11px;text-transform:uppercase;border:1px solid transparent}
.sev-CRITICAL{background:rgba(248,113,113,0.2);color:var(--bad);border-color:var(--bad)}
.kev-active{background:var(--bad);color:white;animation:pulse 2s infinite}
@keyframes pulse { 0% {opacity:1} 50% {opacity:0.7} 100% {opacity:1} }
.grid-3{display:grid;grid-template-columns:repeat(auto-fit, minmax(300px, 1fr));gap:15px;margin-top:15px}
.matrix-card{border-top:4px solid var(--accent);padding:10px;background:rgba(255,255,255,0.03);border-radius:8px}
#pivotSvg{width:100%;height:500px;background:rgba(0,0,0,0.2);border-radius:10px;border:1px solid var(--line);margin-top:20px}
.log{font-family:var(--mono);font-size:12px;max-height:150px;overflow:auto;background:#000;padding:10px;border-radius:8px}
</style>
</head>

<body>
<header>
  <h1>X-Force Intelligence Analyser</h1>
  <p class="muted">Mapping complet : NVD (CVE) → CWE → CAPEC → ATT&CK (Matrices) → ATM Perso</p>
</header>

<main>
  <div class="card">
    <div class="row">
      <input id="cveInput" class="mono" style="flex:1" placeholder="CVE-2023-34362" value="CVE-2023-34362" />
      <button id="searchBtn">Lancer l'Analyse Totale</button>
      <span id="status" class="muted">Prêt.</span>
    </div>
  </div>

  <div id="results"></div>
</main>

<div class="monitor">
  <div class="card">
    <b>Logs d'exécution</b>
    <div id="log" class="log"></div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const APIS = {
    nvd: "https://services.nvd.nist.gov/rest/json/cves/2.0?cveId=",
    kev: "build/kev.json" // Utilise le fichier local généré par ton script Python
};

let MITRE_INDEX, CWE_DB, CAPEC_DB, ATM_DB;

/* ================= UTILS ================= */
function log(msg, color="var(--txt)"){
    const l=document.getElementById("log");
    l.innerHTML+=`<div style="color:${color}">> ${msg}</div>`;
    l.scrollTop=l.scrollHeight;
}

/* ================= CHARGEMENT ================= */
async function loadAllBases() {
    if (MITRE_INDEX) return;
    log("Chargement des référentiels sécurisés...");
    try {
        const [m, cwe, capec, atmText] = await Promise.all([
            fetch('build/mitre_map_index.json').then(r => r.json()),
            fetch('data/cwe_db.json').then(r => r.json()),
            fetch('data/capec_db.json').then(r => r.json()),
            fetch('data/ATM-matrix-TTP.csv').then(r => r.text())
        ]);
        MITRE_INDEX = m; CWE_DB = cwe; CAPEC_DB = capec;
        ATM_DB = parseATM(atmText);
        log("Toutes les bases sont prêtes ✅", "var(--ok)");
    } catch (e) {
        log("Erreur de chargement: " + e.message, "var(--bad)");
    }
}

function parseATM(csv) {
    return csv.split(/\r?\n/).slice(1).filter(l => l.trim()).map(line => {
        const c = line.split(";").map(x => x.trim());
        return { tactic: c[0], id: c[1], name: c[2], techniques: (c[3]||"").split(",").filter(Boolean) };
    });
}

/* ================= ANALYSE ================= */
async function searchCVE() {
    const id = document.getElementById('cveInput').value.trim().toUpperCase();
    if(!id.startsWith("CVE-")) return alert("Format CVE invalide");
    
    document.getElementById("status").textContent = "Analyse en cours...";
    await loadAllBases();

    try {
        const [nvdRes, kevRes] = await Promise.all([
            fetch(APIS.nvd + id).then(r => r.json()),
            fetch(APIS.kev).then(r => r.json()).catch(() => ({ vulnerabilities: [] }))
        ]);

        const cve = nvdRes.vulnerabilities?.[0]?.cve;
        if(!cve) throw new Error("CVE non trouvée au NVD");
        
        const isKev = kevRes.vulnerabilities.some(v => v.cveID === id);
        renderUI(cve, isKev);
    } catch (e) {
        log("Erreur d'analyse: " + e.message, "var(--bad)");
    }
}

function renderUI(cve, isKev) {
    const metrics = cve.metrics?.cvssMetricV31?.[0] || cve.metrics?.cvssMetricV30?.[0];
    const score = metrics?.cvssData?.baseScore || "N/A";
    const sev = metrics?.cvssData?.baseSeverity || "UNKNOWN";
    const cwes = (cve.weaknesses || []).flatMap(w => w.description.map(d => d.value.split('-')[1])).filter(Boolean);

    document.getElementById("results").innerHTML = `
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:flex-start">
                <h2>${cve.id} ${isKev ? '<span class="badge kev-active">⚠ CISA KEV Exploited</span>' : ''}</h2>
                <div class="badge sev-${sev}">CVSS ${score} / ${sev}</div>
            </div>
            <p class="muted">${cve.descriptions.find(d => d.lang === 'en')?.value || ""}</p>
            
            <div class="grid-3">
                <div class="matrix-card">
                    <b>CWE Détectées</b>
                    <div style="margin-top:8px">${cwes.map(c => `<button onclick="drill('${c}')" style="background:none; color:var(--accent); border:1px solid var(--line); padding:4px 8px; margin:2px">CWE-${c}</button>`).join('')}</div>
                </div>
                <div id="mitre-stats" class="matrix-card" style="grid-column: span 2">
                    <b>Couverture MITRE ATT&CK</b>
                    <div id="matrix-badges" style="margin-top:8px">Cliquez sur une CWE pour mapper les matrices.</div>
                </div>
            </div>
            <div id="drilldown-area"></div>
            <svg id="pivotSvg"></svg>
        </div>
    `;
    
    if(cwes.length > 0) drill(cwes[0]); // Drill auto sur la première CWE
}

async function drill(cweId) {
    log(`Analyse approfondie pour CWE-${cweId}...`);
    const tids = new Set();
    
    // 1. Récupération des CAPEC liés
    const capecIds = CWE_DB[cweId]?.RelatedAttackPatterns || [];
    const capecs = [];

    capecIds.forEach(id => {
        const capecData = CAPEC_DB[id];
        if (capecData) {
            capecs.push({ id: id, name: capecData.name });
            
            // On récupère TOUT le texte disponible dans l'objet CAPEC pour chercher les T-IDs
            // On cherche dans 'techniques', mais aussi dans 'description' au cas où
            const fullText = (capecData.techniques || "") + " " + (capecData.description || "");
            
            // Expression régulière qui trouve tous les Txxxx ou Txxxx.xxx
            const matches = fullText.match(/T\d{4}(\.\d{3})?/g);
            if (matches) {
                matches.forEach(t => tids.add(t));
            }
        }
    });

    const listTids = Array.from(tids);
    log(`${capecs.length} CAPEC trouvés. ${listTids.length} techniques ATT&CK extraites.`);

    // 2. Mise à jour de l'affichage et du graphique
    renderMatrices(listTids);
    renderATM(listTids);
    drawPivot(cweId, capecs, listTids);
}

function renderMatrices(tids) {
    const area = document.getElementById("matrix-badges");
    const counts = { enterprise: 0, mobile: 0, ics: 0 };
    
    tids.forEach(t => {
        if(MITRE_INDEX[t]) {
            MITRE_INDEX[t].m.forEach(m => counts[m]++);
        }
    });

    area.innerHTML = `
        <span class="badge" style="background:var(--ent); color:#000">Enterprise: ${counts.enterprise}</span>
        <span class="badge" style="background:var(--mob); color:#000">Mobile: ${counts.mobile}</span>
        <span class="badge" style="background:var(--ics); color:#000">ICS: ${counts.ics}</span>
    `;
}

function renderATM(tids) {
    const hits = ATM_DB.filter(a => a.techniques.some(t => tids.includes(t)));
    const drillArea = document.getElementById("drilldown-area");
    
    drillArea.innerHTML = `
        <div class="card" style="border-left:4px solid var(--warn)">
            <h3>Mapping ATM (Auto-ISAC)</h3>
            <div class="grid-3">
                ${hits.map(h => `
                    <div style="padding:10px; border:1px solid var(--line); border-radius:6px">
                        <b style="color:var(--warn)">${h.id}</b><br>${h.name}<br>
                        <small class="muted">Tactic: ${h.tactic}</small>
                    </div>
                `).join('') || "Aucun lien ATM direct trouvé."}
            </div>
        </div>
    `;
}

/* ================= GRAPH ================= */
function drawPivot(cwe, capecs, tids) {
    const svg = document.getElementById("pivotSvg");
    svg.innerHTML = "";
    const ns = "http://www.w3.org/2000/svg";
    
    const x = { cwe: 50, capec: 300, attack: 650, atm: 1000 };
    
    // Nodes
    drawBox(svg, x.cwe, 250, "CWE-" + cwe, varColor('--accent'));
    
    capecs.slice(0, 5).forEach((c, i) => {
        const y = 80 + (i * 80);
        drawBox(svg, x.capec, y, "CAPEC-" + c.id, "#fff");
        drawCurve(svg, x.cwe + 120, 250, x.capec, y);
        
        // Link to ATT&CK (simplified)
        if(i === 0) {
            tids.slice(0, 6).forEach((t, ti) => {
                const ty = 50 + (ti * 60);
                drawBox(svg, x.attack, ty, t, varColor('--ent'));
                drawCurve(svg, x.capec + 120, y, x.attack, ty);
            });
        }
    });

    log(`Graphique généré pour CWE-${cwe} avec ${tids.length} techniques.`, "var(--ok)");
}

function varColor(name) { return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }

function drawBox(svg, x, y, txt, color) {
    const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
    const r = document.createElementNS("http://www.w3.org/2000/svg", "rect");
    r.setAttribute("x", x); r.setAttribute("y", y - 15);
    r.setAttribute("width", 120); r.setAttribute("height", 30);
    r.setAttribute("fill", "#121a33"); r.setAttribute("stroke", color); r.setAttribute("rx", 5);
    const t = document.createElementNS("http://www.w3.org/2000/svg", "text");
    t.setAttribute("x", x + 60); t.setAttribute("y", y + 5);
    t.setAttribute("fill", "#fff"); t.setAttribute("text-anchor", "middle");
    t.setAttribute("font-size", "11"); t.setAttribute("font-family", "monospace");
    t.textContent = txt;
    g.appendChild(r); g.appendChild(t);
    svg.appendChild(g);
}

function drawCurve(svg, x1, y1, x2, y2) {
    const p = document.createElementNS("http://www.w3.org/2000/svg", "path");
    const d = `M ${x1} ${y1} C ${(x1+x2)/2} ${y1}, ${(x1+x2)/2} ${y2}, ${x2} ${y2}`;
    p.setAttribute("d", d); p.setAttribute("fill", "none");
    p.setAttribute("stroke", "rgba(122, 162, 255, 0.2)"); p.setAttribute("stroke-width", "1");
    svg.appendChild(p);
}

document.getElementById("searchBtn").onclick = searchCVE;
log("Prêt pour l'analyse.");
</script>
</body>
</html>
