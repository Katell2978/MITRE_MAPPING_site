<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Recherche CVE / CPE → CWE → CAPEC → ATT&CK + ATM</title>

<style>
:root{
  --bg:#0b1020; --card:#121a33; --txt:#e9ecff; --muted:#aab3da;
  --accent:#7aa2ff; --ok:#36d399; --warn:#fbbf24; --bad:#f87171; --line:#26325f;
  --mono: ui-monospace, Menlo, Consolas, monospace;
  --sans: system-ui, Segoe UI, Roboto, Arial, sans-serif;
}
body{margin:0;font-family:var(--sans);background:linear-gradient(160deg,#070a15,var(--bg));color:var(--txt);}
header,main,.monitor{max-width:1100px;margin:auto;padding:18px;}
h1{margin:0 0 8px;font-size:22px}
.card{background:rgba(18,26,51,.95);border:1px solid var(--line);border-radius:14px;padding:14px;margin-top:14px}
.row{display:flex;gap:10px;flex-wrap:wrap}
input,select,button{
  padding:10px;border-radius:10px;border:1px solid var(--line);
  background:#0a0f22;color:var(--txt)
}
button{cursor:pointer}
button:hover{border-color:#3b4aa0}
.mono{font-family:var(--mono)}
.muted{color:var(--muted)}
.pill{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:3px 8px;font-size:12px;margin:2px}
.tag{border:1px solid var(--line);border-radius:999px;padding:2px 6px;font-size:11px;margin-left:4px}
.spinner{width:12px;height:12px;border:2px solid #fff3;border-top-color:#fff;border-radius:50%;display:inline-block;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.log{font-family:var(--mono);font-size:12px;max-height:200px;overflow:auto}
.log .ok{color:var(--ok)} .log .bad{color:var(--bad)}
</style>
</head>

<body>

<header>
<h1>Recherche CVE / CPE → CWE → CAPEC → ATT&CK + ATM</h1>
<p class="muted">Drilldown sécurité avec contextualisation automotive (ATM / DET / DC).</p>
</header>

<main>
<div class="card">
  <div class="row">
    <select id="mode">
      <option value="cve">Recherche CVE</option>
      <option value="cpe">Recherche CPE</option>
    </select>
    <input id="queryInput" value="CVE-2023-48010"/>
    <button id="searchBtn">Rechercher</button>
  </div>
  <div id="status" class="muted">Prêt.</div>
</div>

<div id="results"></div>
</main>

<div class="monitor">
<div class="card">
<b>Moniteur</b>
<div id="log" class="log"></div>
</div>
</div>

<script>
console.log("JS chargé ✅");

/* ---------- Utils ---------- */
function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g,c=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}
function log(msg,cls=""){
  const l=document.getElementById("log");
  l.innerHTML+=`<div class="${cls}">${escapeHtml(msg)}</div>`;
  l.scrollTop=l.scrollHeight;
}
function setStatus(t){document.getElementById("status").textContent=t}

/* ---------- ATM Loader ---------- */
let ATM=null;
async function loadATM(){
  if(ATM) return ATM;
  log("Chargement ATM-matrix-TTP.csv…");
  const txt=await fetch("./data/ATM-matrix-TTP.csv").then(r=>r.text());
  const rows=txt.split(/\r?\n/).slice(1).filter(Boolean).map(l=>{
    const c=l.split(";").map(x=>x.trim());
    return {
      tactic:c[0], atm:c[1], label:c[2],
      ent:(c[3]||"").split(",").map(x=>x.trim()).filter(Boolean),
      mob:(c[4]||"").split(",").map(x=>x.trim()).filter(Boolean),
      det:(c[5]||"").split(",").map(x=>x.trim()).filter(Boolean),
      dc:(c[6]||"").match(/DC\d{4}/g)||[],
      on:c[12]==="Y", off:c[13]==="Y", rmq:c[14]||""
    };
  });
  ATM=rows;
  log(`ATM chargé (${rows.length} lignes)`,"ok");
  return rows;
}

/* ---------- NVD ---------- */
const NVD="https://services.nvd.nist.gov/rest/json/cves/2.0";

async function searchCVE(id){
  setStatus("Recherche CVE…");
  log(`Recherche CVE ${id}`);
  const j=await fetch(`${NVD}?cveId=${id}`).then(r=>r.json());
  const cve=j.vulnerabilities?.[0]?.cve;
  if(!cve){log("CVE introuvable","bad");return;}
  renderCVE(cve);
}

function renderCVE(cve){
  const div=document.getElementById("results");
  div.innerHTML=`
<div class="card">
<h2>${cve.id}</h2>
<p>${escapeHtml(cve.descriptions?.[0]?.value||"")}</p>
<div id="cwes"></div>
<div id="drill" class="card muted">Clique sur une CWE</div>
</div>`;
  const cwes=(cve.weaknesses||[]).flatMap(w=>w.description||[])
    .map(d=>d.value.match(/CWE-(\d+)/)?.[1]).filter(Boolean);
  document.getElementById("cwes").innerHTML=cwes.map(c=>
    `<span class="pill"><button onclick="drill('${cve.id}','${c}')">CWE-${c}</button></span>`
  ).join("");
}

async function drill(cveId,cwe){
  const d=document.getElementById("drill");
  d.innerHTML='<span class="spinner"></span> Calcul ATT&CK + ATM…';

  /* ATT&CK simulé minimal (existant chez toi via CAPEC) */
  const techniques=["T1552","T1040"]; // exemple

  const atm=await loadATM();
  const hits=atm.filter(r=>
    r.ent.some(t=>techniques.includes(t))||
    r.mob.some(t=>techniques.includes(t))
  );

  d.innerHTML=`
<h3>ATM / Détection</h3>
<ul>
${hits.map(h=>`
<li>
<b>${h.atm}</b> – ${escapeHtml(h.label)}
<span class="tag">${h.tactic}</span>
${h.on?'<span class="tag">Onboard</span>':''}
${h.off?'<span class="tag">Offboard</span>':''}
<div class="muted">DET: ${h.det.join(", ")} | DC: ${h.dc.join(", ")}</div>
</li>`).join("")}
</ul>`;
}

/* ---------- CPE ---------- */
async function searchCPE(cpe){
  setStatus("Recherche CPE…");
  log(`Recherche CPE ${cpe}`);
  const j=await fetch(`${NVD}?cpeName=${encodeURIComponent(cpe)}&resultsPerPage=20`).then(r=>r.json());
  const ul=j.vulnerabilities.map(v=>
    `<li><a href="#" onclick="searchCVE('${v.cve.id}')">${v.cve.id}</a></li>`
  ).join("");
  document.getElementById("results").innerHTML=`<div class="card"><ul>${ul}</ul></div>`;
}

/* ---------- UI ---------- */
document.getElementById("searchBtn").onclick=()=>{
  const m=document.getElementById("mode").value;
  const q=document.getElementById("queryInput").value.trim();
  if(m==="cve") searchCVE(q);
  else searchCPE(q);
};

setStatus("Prêt.");
</script>

</body>
</html>
