<!doctype html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>X-Force Analyser | Multi-Matrix Pivot</title>
    <style>
        :root {
            --bg: #0d1117; --card: #161b22; --txt: #c9d1d9; --muted: #8b949e;
            --accent: #58a6ff; --ent: #7aa2ff; --mob: #d299ff; --ics: #39d353;
            --bad: #f85149; --ok: #238636; --line: #30363d; --mono: ui-monospace, SFMono-Regular, monospace;
        }
        body { margin: 0; font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--txt); }
        header { border-bottom: 1px solid var(--line); padding: 1.5rem; text-align: center; background: #161b22; }
        .container { max-width: 1200px; margin: auto; padding: 20px; }
        
        /* Search Area */
        .search-box { display: flex; gap: 10px; background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid var(--line); }
        input { flex: 1; background: #0d1117; border: 1px solid var(--line); color: white; padding: 12px; border-radius: 6px; font-family: var(--mono); }
        button { background: var(--ok); color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        
        /* Layout Results */
        .card { background: var(--card); border: 1px solid var(--line); border-radius: 10px; padding: 20px; margin-top: 20px; }
        .matrix-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 20px; }
        @media (max-width: 900px) { .matrix-grid { grid-template-columns: 1fr; } }

        /* Badges & Tags */
        .m-header { font-weight: 800; font-size: 12px; padding: 5px; border-radius: 4px; text-align: center; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.1); }
        .ent-h { color: var(--ent); background: rgba(122, 162, 255, 0.1); border-color: var(--ent); }
        .mob-h { color: var(--mob); background: rgba(210, 153, 255, 0.1); border-color: var(--mob); }
        .ics-h { color: var(--ics); background: rgba(57, 211, 83, 0.1); border-color: var(--ics); }
        
        .tech-item { background: #0d1117; padding: 10px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid transparent; }
        .ent-l { border-left-color: var(--ent); }
        .mob-l { border-left-color: var(--mob); }
        .ics-l { border-left-color: var(--ics); }

        .tag { font-size: 10px; background: #21262d; border: 1px solid var(--line); padding: 2px 6px; border-radius: 4px; color: var(--muted); margin-right: 3px; }
        .pill { display: inline-block; padding: 5px 12px; border-radius: 20px; background: #21262d; border: 1px solid var(--line); font-size: 13px; margin: 4px; cursor: pointer; transition: 0.2s; }
        .pill:hover { border-color: var(--accent); background: #30363d; }
        
        .spinner { border: 3px solid rgba(255,255,255,.1); border-top: 3px solid var(--accent); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #log { font-family: var(--mono); font-size: 11px; margin-top: 20px; color: var(--muted); padding: 10px; background: #000; border-radius: 5px; max-height: 80px; overflow-y: auto; }
    </style>
</head>
<body>

<header>
    <h1>X-Force CVE Analyser</h1>
    <p style="color:var(--muted)">Pivotement : CVE → CWE → CAPEC → MITRE ATT&CK (Enterprise, Mobile, ICS)</p>
</header>

<div class="container">
    <div class="search-box">
        <input id="cveInput" type="text" placeholder="Entrez une CVE (ex: CVE-2023-34362)" value="CVE-2023-34362">
        <button id="searchBtn">Lancer l'Analyse</button>
    </div>

    <div id="results"></div>
    <div id="log">Initialisation système...</div>
</div>

<script>
/* ================= CONFIGURATION ================= */
const NVD_API = "https://services.nvd.nist.gov/rest/json/cves/2.0";
const BUILD_PATH = "./build/mitre_map_index.json";
const DATA_PATH = "./data";

let MITRE_INDEX = null;
let CWE_DB = null, CAPEC_DB = null;

/* ================= UTILS ================= */
function log(msg, color="") {
    const l = document.getElementById("log");
    l.innerHTML += `<div style="color:${color}">${msg}</div>`;
    l.scrollTop = l.scrollHeight;
}

/* ================= CHARGEMENT DES BASES ================= */
async function initBases() {
    if (MITRE_INDEX) return;
    try {
        log("Chargement de l'index optimisé depuis /build...");
        const [m, cwe, capec] = await Promise.all([
            fetch(BUILD_PATH).then(r => r.json()),
            fetch(`${DATA_PATH}/cwe_db.json`).then(r => r.json()),
            fetch(`${DATA_PATH}/capec_db.json`).then(r => r.json())
        ]);
        MITRE_INDEX = m;
        CWE_DB = cwe;
        CAPEC_DB = capec;
        log("Toutes les bases sont prêtes ✅", "#39d353");
    } catch (e) {
        log("Erreur critique au chargement : " + e.message, "#f85149");
    }
}

/* ================= LOGIQUE DE PIVOT ================= */
function getTechniquesFromCWE(cweId) {
    const entry = CWE_DB[cweId];
    if (!entry) return [];
    const tids = new Set();
    (entry.RelatedAttackPatterns || []).forEach(capecId => {
        const capec = CAPEC_DB[capecId];
        if (capec?.techniques) {
            const matches = capec.techniques.match(/T\d{4}(\.\d{3})?/g);
            if (matches) matches.forEach(t => tids.add(t));
        }
    });
    return Array.from(tids);
}

/* ================= RECHERCHE CVE ================= */
async function searchCVE() {
    const id = document.getElementById("cveInput").value.trim().toUpperCase();
    if (!id) return;

    const resDiv = document.getElementById("results");
    resDiv.innerHTML = `<div class="card"><span class="spinner"></span> Interrogation du NVD et calcul des pivots...</div>`;

    try {
        await initBases();
        const resp = await fetch(`${NVD_API}?cveId=${id}`);
        const data = await resp.json();
        const cve = data.vulnerabilities?.[0]?.cve;

        if (!cve) throw new Error("CVE non trouvée dans la base NVD.");

        const cwes = (cve.weaknesses || []).flatMap(w => w.description || [])
                        .map(d => d.value.match(/CWE-(\d+)/)?.[1]).filter(Boolean);

        const score = cve.metrics?.cvssMetricV31?.[0]?.cvssData?.baseScore || "N/A";

        resDiv.innerHTML = `
            <div class="card">
                <div style="display:flex; justify-content:space-between">
                    <h2>${cve.id}</h2>
                    <span class="pill" style="border-color:var(--bad)">CVSS : ${score}</span>
                </div>
                <p style="color:var(--muted); font-size:14px">${cve.descriptions.find(d => d.lang === 'en')?.value}</p>
                <div style="margin-top:15px">
                    <b>CWE associées (Cliquez pour pivoter) :</b><br>
                    ${cwes.map(c => `<span class="pill" onclick="drillDown('${c}')">CWE-${c}</span>`).join('')}
                </div>
            </div>
            <div id="drill-zone"></div>
        `;
    } catch (e) {
        resDiv.innerHTML = `<div class="card" style="border-color:var(--bad)">Erreur : ${e.message}</div>`;
    }
}

/* ================= AFFICHAGE TECHNIQUES ================= */
function drillDown(cweId) {
    const zone = document.getElementById("drill-zone");
    zone.innerHTML = `<div class="card">Analyse des matrices pour CWE-${cweId}...</div>`;
    
    const tids = getTechniquesFromCWE(cweId);
    
    const matrices = [
        { id: 'enterprise', label: 'ENTERPRISE', class: 'ent' },
        { id: 'mobile', label: 'MOBILE', class: 'mob' },
        { id: 'ics', label: 'ICS', class: 'ics' }
    ];

    let html = `<h3>Résultats pour CWE-${cweId}</h3><div class="matrix-grid">`;

    matrices.forEach(m => {
        const found = tids.filter(tid => MITRE_INDEX[tid]?.m.includes(m.id));
        
        html += `
            <div class="card" style="margin-top:0">
                <div class="m-header ${m.class}-h">${m.label}</div>
                ${found.length > 0 ? found.map(tid => {
                    const info = MITRE_INDEX[tid];
                    return `
                        <div class="tech-item ${m.class}-l">
                            <a href="https://attack.mitre.org/techniques/${tid}" target="_blank" style="color:var(--accent); text-decoration:none; font-weight:bold">${tid}</a>
                            <div style="font-size:13px; margin:4px 0">${info.n}</div>
                            <div>${info.t.map(tac => `<span class="tag">${tac}</span>`).join('')}</div>
                        </div>
                    `;
                }).join('') : '<div class="muted" style="text-align:center; font-size:12px">Aucune technique</div>'}
            </div>
        `;
    });

    html += `</div>`;
    zone.innerHTML = html;
}

document.getElementById("searchBtn").onclick = searchCVE;
</script>
</body>
</html>
