<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>X-Force Analyser – NVD → CWE → CAPEC → ATT&CK → ATM</title>

<style>
:root{
  --bg:#0b1020; --card:#121a33; --txt:#e9ecff; --muted:#aab3da;
  --accent:#7aa2ff; --ok:#36d399; --warn:#fbbf24; --bad:#f87171; --line:#26325f;
  --ent:#7aa2ff; --mob:#d299ff; --ics:#39d353;
  --mono: ui-monospace, Menlo, Consolas, monospace;
}
body{margin:0;font-family:system-ui,sans-serif;background:linear-gradient(160deg,#070a15,var(--bg));color:var(--txt);font-size:14px;}
header,main,.monitor{max-width:1300px;margin:auto;padding:18px}
.card{background:rgba(18,26,51,.95);border:1px solid var(--line);border-radius:14px;padding:18px;margin-top:14px}
.row{display:flex;gap:10px;align-items:center}
input,button{padding:12px;border-radius:10px;border:1px solid var(--line);background:#0a0f22;color:var(--txt)}
button{cursor:pointer;font-weight:bold;background:var(--accent);color:#000;border:none}
.badge{padding:4px 10px;border-radius:6px;font-weight:bold;font-size:11px;text-transform:uppercase;border:1px solid transparent}
.sev-CRITICAL{background:rgba(248,113,113,0.2);color:var(--bad);border-color:var(--bad)}
.kev-active{background:var(--bad);color:white;animation:pulse 2s infinite}
@keyframes pulse { 0% {opacity:1} 50% {opacity:0.7} 100% {opacity:1} }
.grid-3{display:grid;grid-template-columns:repeat(auto-fit, minmax(300px, 1fr));gap:15px;margin-top:15px}
.matrix-card{border-top:4px solid var(--accent);padding:10px;background:rgba(255,255,255,0.03);border-radius:8px}
#pivotSvg{width:100%;height:500px;background:rgba(0,0,0,0.2);border-radius:10px;border:1px solid var(--line);margin-top:20px}
.log{font-family:var(--mono);font-size:12px;max-height:150px;overflow:auto;background:#000;padding:10px;border-radius:8px}
</style>
</head>

<body>
<header>
  <h1>CVE Analyser By Katell2978</h1>
  <p class="muted">Mapping complet : NVD (CVE) → CWE → CAPEC → ATT&CK (Matrices) → ATM Perso</p>
</header>

<main>
  <div class="card">
    <div class="row">
      <input id="cveInput" class="mono" style="flex:1" placeholder="CVE-2023-34362" value="CVE-2023-34362" />
      <button id="searchBtn">Lancer l'Analyse Totale</button>
      <span id="status" class="muted">Prêt.</span>
    </div>
  </div>

  <div id="results"></div>
</main>

<div class="monitor">
  <div class="card">
    <b>Logs d'exécution</b>
    <div id="log" class="log"></div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const APIS = {
    nvd: "https://services.nvd.nist.gov/rest/json/cves/2.0?cveId=",
    kev: "build/kev.json"
};

let MITRE_INDEX = {}, CWE_DB = {}, CAPEC_DB = {}, ATM_DB = [];

/* ================= CHARGEMENT ================= */
async function loadAllBases() {
    if (Object.keys(CWE_DB).length > 0) return;
    console.log("Chargement des bases...");
    try {
        const [m, cwe, capec, atmText] = await Promise.all([
            fetch('build/mitre_map_index.json').then(r => r.json()).catch(()=>({})),
            fetch('data/cwe_db.json').then(r => r.json()),
            fetch('data/capec_db.json').then(r => r.json()),
            fetch('data/ATM-matrix-TTP.csv').then(r => r.text()).catch(()=>"")
        ]);
        MITRE_INDEX = m; CWE_DB = cwe; CAPEC_DB = capec;
        ATM_DB = parseATM(atmText);
        console.log("Bases chargées :", {mitre: Object.keys(m).length, cwe: Object.keys(cwe).length});
    } catch (e) {
        console.error("Erreur chargement:", e);
    }
}

function parseATM(csv) {
    if(!csv) return [];
    return csv.split(/\r?\n/).slice(1).filter(l => l.trim()).map(line => {
        const c = line.split(";").map(x => x.trim());
        return { tactic: c[0], id: c[1], name: c[2], techniques: (c[3]||"").split(",").map(t=>t.trim()) };
    });
}

/* ================= ANALYSE ================= */
async function searchCVE() {
    const id = document.getElementById('cveInput').value.trim().toUpperCase();
    await loadAllBases();
    try {
        const nvdRes = await fetch(APIS.nvd + id).then(r => r.json());
        const kevRes = await fetch(APIS.kev).then(r => r.json()).catch(() => ({ vulnerabilities: [] }));
        const cve = nvdRes.vulnerabilities?.[0]?.cve;
        if(!cve) return alert("CVE introuvable");
        const isKev = (kevRes.vulnerabilities || []).some(v => v.cveID === id);
        renderUI(cve, isKev);
    } catch (e) { console.error(e); }
}

function renderUI(cve, isKev) {
    const cwes = (cve.weaknesses || []).flatMap(w => w.description.map(d => d.value.split('-')[1])).filter(Boolean);
    
    document.getElementById("results").innerHTML = `
        <div class="card">
            <h2>${cve.id} ${isKev ? '⚠️ KEV' : ''}</h2>
            <div id="cwe-area"></div>
            <div id="capec-area" class="card" style="background:rgba(255,255,255,0.05)">
                <h3>CAPEC & Techniques</h3>
                <div id="matrix-badges"></div>
                <ul id="capec-list"></ul>
            </div>
            <div id="atm-area"></div>
        </div>
    `;

    cwes.forEach(c => {
        const btn = document.createElement("button");
        btn.textContent = "CWE-" + c;
        btn.onclick = () => drill(c);
        document.getElementById("cwe-area").appendChild(btn);
    });

    if(cwes.length > 0) drill(cwes[0]);
}

async function drill(cweId) {
    const listElt = document.getElementById("capec-list");
    listElt.innerHTML = "Chargement...";
    const tids = new Set();
    
    // Support dictionnaire ou tableau
    const cweKey = CWE_DB[cweId] ? cweId : `CWE-${cweId}`;
    const cweData = CWE_DB[cweKey];
    const capecIds = cweData?.RelatedAttackPatterns || [];

    if(capecIds.length === 0) listElt.innerHTML = "<li>Aucun CAPEC lié trouvé.</li>";
    else listElt.innerHTML = "";

    capecIds.forEach(id => {
        const cap = CAPEC_DB[id];
        if(cap) {
            const li = document.createElement("li");
            li.innerHTML = `<b>CAPEC-${id}</b>: ${cap.name}`;
            listElt.appendChild(li);

            // Extraction des T-IDs (Techniques)
            const txt = JSON.stringify(cap);
            const matches = txt.match(/T\d{4}(\.\d{3})?/g);
            if(matches) matches.forEach(t => tids.add(t));
        }
    });

    const finalTids = Array.from(tids);
    updateBadges(finalTids);
    renderATM(finalTids);
}

function updateBadges(tids) {
    const counts = { enterprise: 0, mobile: 0, ics: 0 };
    tids.forEach(t => {
        const info = MITRE_INDEX[t];
        if(info && info.m) info.m.forEach(m => counts[m]++);
        else counts.enterprise++; // Fallback si mapping incomplet
    });
    document.getElementById("matrix-badges").innerHTML = `
        <b style="color:var(--accent)">Enterprise: ${counts.enterprise}</b> | 
        <b style="color:var(--mob)">Mobile: ${counts.mobile}</b> | 
        <b style="color:var(--ics)">ICS: ${counts.ics}</b>
    `;
}

function renderATM(tids) {
    const area = document.getElementById("atm-area");
    const hits = ATM_DB.filter(a => a.techniques.some(t => tids.includes(t)));
    area.innerHTML = `<h3>ATM Mapping (${hits.length})</h3>`;
    hits.forEach(h => {
        area.innerHTML += `<div class="card" style="border-left:3px solid var(--warn)">${h.id} - ${h.name} <br><small>Tactic: ${h.tactic}</small></div>`;
    });
}

document.getElementById("searchBtn").onclick = searchCVE;
</script>
</body>
</html>
