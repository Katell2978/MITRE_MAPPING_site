<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Kat-Force Analyser ‚Äì NVD ‚Üí CWE ‚Üí EMB3D</title>

  <style>
    :root {
      --bg: #070a15; --card: #121a33; --txt: #e9ecff; --accent: #7aa2ff;
      --bad: #f87171; --ok: #36d399; --warn: #fbbf24; --line: #26325f;
    }
    body { background: var(--bg); color: var(--txt); font-family: sans-serif; padding: 20px; }
    h1 { border-bottom: 2px solid var(--accent); padding-bottom: 10px; margin: 0; }
    .topbar { display:flex; justify-content:space-between; align-items:center; gap: 12px; flex-wrap: wrap; }
    nav { margin-bottom: 16px; }
    nav a { color: var(--accent); margin-right: 15px; text-decoration: none; font-weight: 800; }
    nav a:hover { text-decoration: underline; }

    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 14px 16px;
      margin-top: 14px;
    }

    .row { display:flex; gap: 14px; flex-wrap: wrap; align-items: stretch; }
    .col { flex: 1 1 340px; min-width: 320px; }

    label { font-size: 0.9em; opacity: 0.9; }
    input[type="text"] {
      width: min(520px, 100%);
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.04);
      color: var(--txt);
      outline: none;
      font-weight: 800;
      letter-spacing: 0.3px;
    }

    button {
      background: var(--accent);
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 900;
      color: #000;
    }
    button:disabled { opacity: 0.6; cursor: not-allowed; }

    .badge {
      display:inline-block;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 0.75em;
      font-weight: 900;
      margin-right: 6px;
      margin-top: 6px;
    }
    .bg-ok { background: var(--ok); color:#000; }
    .bg-bad { background: var(--bad); color:#000; }
    .bg-warn { background: var(--warn); color:#000; }
    .bg-info { background: rgba(122,162,255,0.18); border: 1px solid rgba(122,162,255,0.35); color: var(--txt); }

    .muted { opacity: 0.88; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }

    .grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(240px, 1fr));
      gap: 10px;
    }
    @media (max-width: 980px) {
      .grid { grid-template-columns: repeat(2, minmax(240px, 1fr)); }
    }
    @media (max-width: 680px) {
      .grid { grid-template-columns: 1fr; }
    }

    .kpi {
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px 12px;
    }
    .kpi .title { font-size: 0.75em; letter-spacing: 0.8px; text-transform: uppercase; color: var(--accent); }
    .kpi .value { margin-top: 6px; font-size: 1.1em; font-weight: 900; }
    .kpi .sub { margin-top: 4px; font-size: 0.85em; opacity: 0.9; }

    .banner {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.03);
    }
    .banner h3 { margin: 0 0 8px 0; font-size: 0.9em; color: var(--accent); text-transform: uppercase; letter-spacing: 0.8px; }
    .banner .items { display:flex; flex-wrap: wrap; gap: 8px; }
    .pill {
      border: 1px solid rgba(122,162,255,0.35);
      background: rgba(122,162,255,0.10);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 0.82em;
      font-weight: 900;
    }
    .pill.crit { border-color: rgba(248,113,113,0.7); background: rgba(248,113,113,0.12); }
    .pill.warn { border-color: rgba(251,191,36,0.7); background: rgba(251,191,36,0.12); }

    ul { margin: 8px 0 0 20px; }
    li { margin: 4px 0; }

    .links a { color: var(--accent); font-weight: 900; text-decoration: none; }
    .links a:hover { text-decoration: underline; }

    #logs {
      white-space: pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 0.88em;
      background: rgba(0,0,0,0.25);
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px 12px;
      max-height: 240px;
      overflow: auto;
    }

    /* Style sp√©cifique EMB3D */
    .emb3d-card {
      background: rgba(122, 162, 255, 0.08);
      border: 1px solid var(--accent);
      border-radius: 10px;
      padding: 15px;
      margin-top: 15px;
    }
  </style>
</head>

<body>

  <nav>
    <a href="index.html">üîç Analyseur</a>
    <a href="veille.html">üî≠ Veille (Watchtower)</a>
  </nav>

  <div class="topbar">
    <h1>üß† Kat-Force Analyser</h1>
    <div class="muted">Mapping : <b>CVE</b> ‚Üí <b>CWE</b> ‚Üí <b>EMB3D</b></div>
  </div>

  <div class="card">
    <label for="cveInput">CVE √† analyser</label><br/>
    <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top: 8px;">
      <input id="cveInput" type="text" placeholder="Ex: CVE-2025-32058" value="CVE-2025-32058" />
      <button id="runBtn" onclick="runAnalysis()">üöÄ Lancer l'analyse</button>
      <span id="status" class="muted">Pr√™t.</span>
    </div>
  </div>

  <div class="row">
    <div class="col">
      <div class="card">
        <h2 style="margin:0 0 8px 0;">R√©sum√© & Scores</h2>
        <div class="grid">
          <div class="kpi">
            <div class="title">CVSS v3.x Base</div>
            <div id="cvss3" class="value">‚Äî</div>
            <div id="cvss3vec" class="sub mono">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="title">CVSS v4.0 Base</div>
            <div id="cvss4" class="value">‚Äî</div>
            <div id="cvss4vec" class="sub mono">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="title">EPSS (30j)</div>
            <div id="epss" class="value">‚Äî</div>
            <div id="epssPct" class="sub">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="title">KEV (CISA)</div>
            <div id="kev" class="value">‚Äî</div>
            <div id="kevDate" class="sub">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="title">Badges</div>
            <div id="badges" class="sub">‚Äî</div>
          </div>
        </div>
        <div id="exploitBanner" class="banner" style="display:none;">
          <h3>Conditions d‚Äôexploitation & impacts</h3>
          <div id="exploitPills" class="items"></div>
        </div>
      </div>
    </div>

    <div class="col">
      <div class="card">
        <h2 style="margin:0 0 8px 0;">D√©tail de la vuln√©rabilit√©</h2>
        <div id="desc" class="muted">‚Äî</div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col">
      <div class="card">
        <h2 style="margin:0 0 8px 0;">CWE & Mapping EMB3D</h2>
        <div id="cwe" class="muted">‚Äî</div>
        <div id="emb3d-info"></div>
      </div>
    </div>

    <div class="col">
      <div class="card">
        <h2 style="margin:0 0 8px 0;">CAPEC</h2>
        <div id="capec" class="muted">‚Äî</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2 style="margin:0 0 8px 0;">R√©f√©rences (NVD)</h2>
    <div id="refs" class="links muted">‚Äî</div>
  </div>

  <div class="card">
    <h2 style="margin:0 0 8px 0;">Logs</h2>
    <div id="logs">‚Äî</div>
  </div>

<script>
/* ============================================================
   DICTIONNAIRE EMB3D INT√âGR√â (√âvite l'erreur Unexpected Token)
   ============================================================ */
const emb3dMapping = {
  "CWE-787": { tid: "T1.1", threat: "Memory Corruption", category: "Application Software", iot_impact: "Permet souvent l'ex√©cution de code arbitraire (RCE) sur le p√©riph√©rique." },
  "CWE-121": { tid: "T1.1", threat: "Stack-based Buffer Overflow", category: "Application Software", iot_impact: "Tr√®s fr√©quent dans les firmwares C/C++ sans protections de pile." },
  "CWE-20":  { tid: "T1.2", threat: "Injection Attacks", category: "Application Software", iot_impact: "Porte d'entr√©e pour les injections via API ou interfaces Web IoT." },
  "CWE-798": { tid: "T3.1", threat: "Hard-coded Credentials", category: "System Software", iot_impact: "Identifiants 'root' grav√©s en dur dans le binaire du firmware." },
  "CWE-1392": { tid: "T3.1", threat: "Default Credentials", category: "System Software", iot_impact: "Utilisation des mots de passe d'usine (admin/admin) via Telnet/SSH." },
  "CWE-319": { tid: "T4.2", threat: "Cleartext Transmission", category: "Networking", iot_impact: "Donn√©es sensibles transmises sans TLS (HTTP/MQTT), interceptables." },
  "CWE-295": { tid: "T4.3", threat: "Man-in-the-Middle (MitM)", category: "Networking", iot_impact: "L'objet accepte des certificats invalides, facilitant le d√©tournement." },
  "CWE-22":  { tid: "T1.3", threat: "Unauthorized File Access", category: "Application Software", iot_impact: "Lecture de fichiers syst√®me sensibles (/etc/shadow)." }
};

/* ============================================================
   FONCTIONS UTILITAIRES
   ============================================================ */
function log(msg) {
  const el = document.getElementById("logs");
  if (el.textContent.trim() === "‚Äî") el.textContent = "";
  el.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
  el.scrollTop = el.scrollHeight;
}
function setStatus(msg) {
  document.getElementById("status").textContent = msg;
}

async function fetchJson(url, timeoutMs = 12000) {
  const ctrl = new AbortController();
  const t = setTimeout(() => ctrl.abort(), timeoutMs);
  try {
    const r = await fetch(url, { cache: "no-store", signal: ctrl.signal });
    clearTimeout(t);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return await r.json();
  } catch (e) {
    clearTimeout(t);
    throw e;
  }
}

/* ============================================================
   R√âCUP√âRATION DES DONN√âES
   ============================================================ */
async function fetchNvdCve(cveId) {
  return fetchJson(`https://services.nvd.nist.gov/rest/json/cves/2.0?cveId=${encodeURIComponent(cveId)}`);
}

async function fetchEpss(cveId) {
  const data = await fetchJson(`https://api.first.org/data/v1/epss?cve=${encodeURIComponent(cveId)}`);
  return data?.data?.[0] || { epss: null, percentile: null };
}

async function fetchKevStatus(cveId) {
  const kev = await fetchJson("https://raw.githubusercontent.com/cisagov/kev-data/main/known_exploited_vulnerabilities.json");
  const hit = (kev?.vulnerabilities || []).find(v => v?.cveID === cveId);
  return { inKev: !!hit, dateAdded: hit?.dateAdded || null };
}

/* ============================================================
   RENDU UI ET PIVOT EMB3D
   ============================================================ */
function renderResults({ cveId, description, cvss3, cvss4, epss, epssPct, cweList, capecList, refs, kev }) {
  document.getElementById("desc").textContent = description || "‚Äî";

  // Scores CVSS
  document.getElementById("cvss3").textContent = cvss3?.baseScore ?? "‚Äî";
  document.getElementById("cvss3vec").textContent = cvss3?.vectorString ?? "‚Äî";
  document.getElementById("cvss4").textContent = cvss4?.baseScore ?? "‚Äî";
  document.getElementById("cvss4vec").textContent = cvss4?.vectorString ?? "‚Äî";

  // EPSS / KEV
  document.getElementById("epss").textContent = epss ? `${(epss * 100).toFixed(2)}%` : "‚Äî";
  document.getElementById("epssPct").textContent = epssPct ? `Percentile : ${(epssPct * 100).toFixed(0)}e` : "‚Äî";
  document.getElementById("kev").textContent = kev?.inKev ? "Oui" : "Non";
  document.getElementById("kevDate").textContent = kev?.inKev ? `Ajout√© le : ${kev.dateAdded}` : "‚Äî";

  // Badges
  const badges = [];
  if (kev?.inKev) badges.push('<span class="badge bg-bad">KEV</span>');
  if (epss >= 0.20) badges.push('<span class="badge bg-bad">EPSS √©lev√©</span>');
  if (cvss3?.baseScore >= 9.0) badges.push('<span class="badge bg-bad">Critique</span>');
  document.getElementById("badges").innerHTML = badges.join(" ") || "‚Äî";

  // CWE List
  const cweDiv = document.getElementById("cwe");
  if (cweList.length) {
    cweDiv.innerHTML = `<ul>${cweList.map(c => `<li>${c} - <a href="https://cwe.mitre.org/data/definitions/${c.split('-')[1]}.html" target="_blank">Mitre</a></li>`).join("")}</ul>`;
  } else {
    cweDiv.textContent = "‚Äî";
  }

  // --- LE PIVOT EMB3D ---
  const emb3dBox = document.getElementById("emb3d-info");
  emb3dBox.innerHTML = "";
  const match = cweList.find(c => emb3dMapping[c]);
  if (match) {
    const m = emb3dMapping[match];
    emb3dBox.innerHTML = `
      <div class="emb3d-card">
        <div style="font-size:0.75em; color:var(--accent); font-weight:bold; text-transform:uppercase;">üõ°Ô∏è Pivot EMB3D</div>
        <div style="font-weight:900; margin-top:5px;">${m.tid} : ${m.threat}</div>
        <div class="badge bg-info">${m.category}</div>
        <div style="font-size:0.85em; margin-top:10px; opacity:0.9;">${m.iot_impact}</div>
      </div>`;
  }

  // CAPEC List
  const capecDiv = document.getElementById("capec");
  if (capecList.length) {
    capecDiv.innerHTML = `<ul>${capecList.map(c => `<li>CAPEC-${c.id} : ${c.name}</li>`).join("")}</ul>`;
  } else {
    capecDiv.textContent = "‚Äî";
  }

  // R√©f√©rences
  document.getElementById("refs").innerHTML = `<ul>${refs.map(r => `<li><a href="${r}" target="_blank">${r}</a></li>`).join("")}</ul>`;
}

/* ============================================================
   ORCHESTRATION PRINCIPALE
   ============================================================ */
async function runAnalysis() {
  const btn = document.getElementById("runBtn");
  const cveId = document.getElementById("cveInput").value.trim().toUpperCase();
  
  if (!/^CVE-\d{4}-\d{4,}$/.test(cveId)) {
    alert("Format CVE invalide (ex: CVE-2023-1234)");
    return;
  }

  btn.disabled = true;
  log(`Analyse lanc√©e pour ${cveId}`);
  setStatus("Analyse en cours...");

  try {
    const nvd = await fetchNvdCve(cveId);
    const item = nvd?.vulnerabilities?.[0]?.cve;
    if (!item) throw new Error("CVE non trouv√©e.");

    const desc = item.descriptions.find(d => d.lang === "fr")?.value || item.descriptions.find(d => d.lang === "en")?.value;
    const metrics = item.metrics;
    const cvss3 = metrics?.cvssMetricV31?.[0]?.cvssData || metrics?.cvssMetricV30?.[0]?.cvssData;
    const cvss4 = metrics?.cvssMetricV40?.[0]?.cvssData;

    const cweList = [];
    (item.weaknesses || []).forEach(w => {
      w.description.forEach(d => { if (d.value.startsWith("CWE-")) cweList.push(d.value); });
    });

    const epssData = await fetchEpss(cveId);
    const kev = await fetchKevStatus(cveId);
    const refs = (item.references || []).map(r => r.url);

    renderResults({
      cveId, description: desc, cvss3, cvss4,
      epss: epssData.epss, epssPct: epssData.percentile,
      cweList, capecList: [], refs, kev
    });

    setStatus("‚úÖ Analyse termin√©e.");
    log("Analyse termin√©e avec succ√®s.");
  } catch (e) {
    log(`ERREUR : ${e.message}`);
    setStatus("‚ö†Ô∏è Erreur lors de l'analyse.");
  } finally {
    btn.disabled = false;
  }
}

// Lancement auto au chargement
window.onload = runAnalysis;
</script>

</body>
</html>
