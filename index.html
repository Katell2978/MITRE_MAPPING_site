<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kat-Force Analyser â€“ Clean</title>

  <!-- jsPDF (stable) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body { background:#0b1020; color:#e9ecff; font-family:Arial, sans-serif; padding:20px; }
    h1 { border-bottom:2px solid #7aa2ff; padding-bottom:8px; }
    .card { background:#121a33; border:1px solid #26325f; border-radius:10px; padding:14px; margin-top:14px; }
    .row { display:flex; gap:14px; flex-wrap:wrap; }
    .col { flex:1 1 320px; }
    button { background:#7aa2ff; border:none; padding:8px 14px; border-radius:8px; font-weight:700; cursor:pointer; }
    select, input { padding:8px; border-radius:6px; background:#0f1530; color:#fff; border:1px solid #26325f; }
    .muted { opacity:0.85; }
    .badge { display:inline-block; padding:3px 8px; border-radius:6px; font-size:12px; font-weight:700; }
    .bad { background:#f87171; color:#000; }
    .warn { background:#fbbf24; color:#000; }
    .info { background:#7aa2ff33; border:1px solid #7aa2ff55; }
    #logs { white-space:pre-wrap; background:#050814; border:1px solid #26325f; padding:10px; border-radius:8px; max-height:200px; overflow:auto; }
  </style>
</head>

<body>

<h1>ðŸ§  Katâ€‘Force Analyser (Clean)</h1>

<div class="card">
  <label>CVE</label><br>
  <input id="cveInput" value="CVE-2025-32058">
  <button onclick="runAnalysis()">ðŸš€ Lancer</button>
  <span id="status" class="muted">PrÃªt</span>
</div>

<div class="row">
  <div class="col card">
    <h3>RÃ©sumÃ©</h3>
    <div>CVSS v3 : <b id="cvss3">â€”</b></div>
    <div>CVSS v4 : <b id="cvss4">â€”</b></div>
    <div>EPSS : <b id="epss">â€”</b></div>
    <div>KEV : <b id="kev">â€”</b></div>
  </div>

  <div class="col card">
    <h3>Description</h3>
    <div id="desc" class="muted">â€”</div>
  </div>
</div>

<div class="card">
  <h3>ðŸ“‹ Suivi / Triage</h3>

  <label>Vehicle assets impacted</label><br>
  <select id="fu_assets">
    <option value="unknown">Inconnu</option>
    <option value="yes">Oui</option>
    <option value="no">Non</option>
  </select>

  <br><br>

  <label>Exploitation</label><br>
  <select id="fu_exploit">
    <option value="none">None</option>
    <option value="poc">PoC</option>
    <option value="active">Active</option>
  </select>

  <br><br>

  <b>DÃ©cision recommandÃ©e :</b>
  <div id="decisionBox" class="muted">â€”</div>

  <br>
  <button onclick="generatePdf()">ðŸ“„ PDF de suivi</button>
</div>

<div class="card">
  <h3>Logs (debug)</h3>
  <div id="logs">â€”</div>
</div>

<script>
/* =========================================================
   CONFIG
========================================================= */
const DEBUG = true;

/* =========================================================
   DEBUG UTILS
========================================================= */
function log(msg, obj) {
  if (!DEBUG) return;
  const el = document.getElementById("logs");
  if (el.textContent === "â€”") el.textContent = "";
  el.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
  if (obj) console.log(msg, obj);
}

function setStatus(s) {
  document.getElementById("status").textContent = s;
}

/* =========================================================
   CORE
========================================================= */
async function runAnalysis() {
  try {
    setStatus("Analyse en coursâ€¦");
    log("runAnalysis() appelÃ©");

    const cveId = document.getElementById("cveInput").value.trim();
    if (!/^CVE-\d{4}-\d+$/i.test(cveId)) {
      throw new Error("Format CVE invalide");
    }

    log("CVE valide", cveId);

    // ---- NVD ----
    const nvdUrl = `https://services.nvd.nist.gov/rest/json/cves/2.0?cveId=${cveId}`;
    log("Fetch NVD", nvdUrl);

    const nvd = await fetch(nvdUrl).then(r => r.json());
    const cve = nvd?.vulnerabilities?.[0]?.cve;
    if (!cve) throw new Error("CVE non trouvÃ©e");

    const desc =
      cve.descriptions?.find(d => d.lang === "fr")?.value ||
      cve.descriptions?.find(d => d.lang === "en")?.value ||
      "â€”";

    document.getElementById("desc").textContent = desc;

    // CVSS
    const cvss3 = cve.metrics?.cvssMetricV31?.[0]?.cvssData?.baseScore ?? "â€”";
    const cvss4 = cve.metrics?.cvssMetricV40?.[0]?.cvssData?.baseScore ?? "â€”";

    document.getElementById("cvss3").textContent = cvss3;
    document.getElementById("cvss4").textContent = cvss4;

    // EPSS
    let epss = "â€”";
    try {
      const epssData = await fetch(`https://api.first.org/data/v1/epss?cve=${cveId}`).then(r => r.json());
      epss = (epssData?.data?.[0]?.epss * 100).toFixed(2) + "%";
    } catch {
      log("EPSS indisponible");
    }
    document.getElementById("epss").textContent = epss;

    // KEV
    let kev = "Non";
    try {
      const kevData = await fetch("https://raw.githubusercontent.com/cisagov/kev-data/main/known_exploited_vulnerabilities.json").then(r => r.json());
      if (kevData.vulnerabilities.some(v => v.cveID === cveId)) kev = "Oui";
    } catch {
      log("KEV indisponible");
    }
    document.getElementById("kev").textContent = kev;

    // ---- RECOMMANDATION ----
    const decision = computeDecision({
      cvss3,
      epss,
      kev,
      assets: document.getElementById("fu_assets").value
    });

    document.getElementById("decisionBox").innerHTML =
      `<span class="badge ${decision.level}">${decision.label}</span><br>${decision.reason}`;

    setStatus("âœ… Analyse terminÃ©e");
    log("Analyse terminÃ©e");

  } catch (e) {
    setStatus("âŒ Erreur");
    log("ERREUR : " + e.message);
  }
}

/* =========================================================
   DECISION ENGINE (simple & robuste)
========================================================= */
function computeDecision(ctx) {
  log("Decision context", ctx);

  if (ctx.assets === "no") {
    return { label:"Dismiss to SOC", level:"info", reason:"Actifs vÃ©hicule non impactÃ©s" };
  }

  if (ctx.kev === "Oui") {
    return { label:"Patch immÃ©diat", level:"bad", reason:"KEV confirmÃ©" };
  }

  if (typeof ctx.cvss3 === "number" && ctx.cvss3 >= 9) {
    return { label:"Patch prioritaire", level:"warn", reason:"CVSS critique" };
  }

  return { label:"Track for change", level:"info", reason:"Aucun signal fort" };
}

/* =========================================================
   PDF
========================================================= */
function generatePdf() {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();

  pdf.text("Katâ€‘Force â€“ Suivi vulnÃ©rabilitÃ©", 10, 15);
  pdf.text("CVE : " + document.getElementById("cveInput").value, 10, 25);
  pdf.text("DÃ©cision : " + document.getElementById("decisionBox").innerText, 10, 35);

  pdf.save("suivi_cve.pdf");
}
</script>

</body>
</html>
