<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Kat-Force ‚Äì Security Watchtower</title>

  <style>
    :root{
      --bg:#070a15; --card:#121a33; --txt:#e9ecff; --accent:#7aa2ff;
      --bad:#f87171; --ok:#36d399; --warn:#fbbf24; --line:#26325f;
    }
    body{background:var(--bg);color:var(--txt);font-family:sans-serif;padding:20px;}
    h1{border-bottom:2px solid var(--accent);padding-bottom:10px;}
    nav{margin-bottom:20px;}
    nav a{color:var(--accent);margin-right:15px;text-decoration:none;font-weight:bold;}
    nav a:hover{text-decoration:underline;}

    table{width:100%;border-collapse:collapse;margin-top:20px;background:var(--card);border-radius:10px;overflow:hidden;box-shadow: 0 4px 15px rgba(0,0,0,0.3);}
    th,td{padding:12px;text-align:left;border-bottom:1px solid var(--line);vertical-align:top;}
    th{
      background:rgba(122,162,255,.1);
      color:var(--accent);
      font-size:.8em;
      text-transform:uppercase;
      cursor:pointer;
      user-select:none;
    }
    th:hover{background:rgba(122,162,255,.2);}
    th.sort-asc::after{content:" ‚ñ≤";}
    th.sort-desc::after{content:" ‚ñº";}

    .badge{padding:4px 8px;border-radius:4px;font-size:.75em;font-weight:bold;display:inline-block;}
    .bg-ok{background:var(--ok);color:#000;}
    .bg-bad{background:var(--bad);color:#000;}
    .bg-warn{background:var(--warn);color:#000;}
    .delta-up{color:var(--bad);font-weight:bold;}

    .sources a{color:var(--accent);font-weight:bold;text-decoration:none;}
    .sources a:hover{text-decoration:underline;}

    /* Correction : Style du bouton de rafra√Æchissement */
    #refreshBtn {
      background: var(--accent);
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      color: #000;
      transition: transform 0.2s;
    }
    #refreshBtn:active { transform: scale(0.95); }
    
    small{opacity:.95; font-size: 0.85em;}
  </style>
</head>

<body>

  <nav>
    <a href="index.html">üîç Analyseur</a>
    <a href="veille.html">üî≠ Veille (Watchtower)</a>
  </nav>

  <div style="display:flex;justify-content:space-between;align-items:center;">
    <h1>üî≠ Watchtower Intelligence</h1>
    <button id="refreshBtn" onclick="refreshData()">üîÑ Actualiser</button>
  </div>

  <div id="summary" style="margin:20px 0; color:var(--accent); font-weight: bold;">Chargement de la veille‚Ä¶</div>

  <div style="overflow-x: auto;">
    <table>
      <thead>
        <tr>
          <th data-key="cve_id">CVE</th>
          <th data-key="status">Status</th>
          <th data-key="cvss">CVSS</th>
          <th data-key="epss">EPSS</th>
          <th data-key="kev">KEV</th>
          <th data-key="remote">Remote</th>
          <th data-key="components">Composants</th>
          <th data-key="sources">Sources</th>
          <th data-key="check">Dernier check</th>
        </tr>
      </thead>
      <tbody id="watch-body"></tbody>
    </table>
  </div>

<script>
// NOTE : Assure-toi que ce fichier existe sur ton GitHub dans le dossier /data/
const DATA_PATH = 'data/vuln-watch.json';
let dataCache = [];
let sortKey = null;
let sortDir = "asc";

async function refreshData() {
  const btn = document.getElementById('refreshBtn');
  if (btn) btn.textContent = "‚åõ Chargement...";

  try {
    // On ajoute un timestamp pour √©viter le cache navigateur
    const res = await fetch(DATA_PATH + '?t=' + Date.now());
    if (!res.ok) throw new Error("Fichier de donn√©es introuvable (404)");

    const json = await res.json();

    if (!json.vulnerabilities) {
      throw new Error("Structure JSON invalide");
    }

    dataCache = Object.values(json.vulnerabilities);
    renderTable(applySort(dataCache));

    document.getElementById('summary').textContent =
      `Analyse de ${dataCache.length} vuln√©rabilit√©(s) active(s).`;

  } catch (e) {
    console.error(e);
    document.getElementById('summary').textContent =
      "‚ö†Ô∏è Erreur : " + e.message;
  } finally {
    if (btn) btn.textContent = "üîÑ Forcer la mise √† jour";
  }
}

// ... Tes fonctions utilitaires (safeDateLabel, isRemoteExploitable, etc.) restent identiques ...

function safeDateLabel(iso, mode) {
  if (!iso) return "‚Äî";
  const d = new Date(iso);
  if (isNaN(d.getTime())) return "‚Äî";
  return mode === "datetime" ? d.toLocaleString('fr-FR') : d.toLocaleDateString('fr-FR');
}

function isRemoteExploitable(v) {
  const av = (v?.exploitation_conditions?.attack_vector || "").toString().toLowerCase();
  return av.includes("remote") || av.includes("network");
}

function renderSources(publications) {
  if (!Array.isArray(publications) || publications.length === 0) return "‚Äî";
  return publications.map(p => {
    const publisher = (p.publisher || p.type || "source").toString();
    const url = (p.url || "").toString();
    return url ? `<a href="${url}" target="_blank" rel="noopener">${publisher}</a>` : `<span>${publisher}</span>`;
  }).join("<br>");
}

function escapeHtml(s){ 
    if(!s) return "";
    return String(s).replace(/[&<>"']/g,c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
}

function renderTable(list) {
  const body = document.getElementById('watch-body');
  body.innerHTML = "";

  list.forEach(v => {
    const cvss = v?.metrics?.cvss || {};
    const epss = v?.metrics?.epss || {};
    const kev  = v?.metrics?.kev_status || {};

    const cvssCurrent = cvss.base_current ?? null;
    const epssCurrent = epss.current ?? null;
    const kevCurrent = !!kev.current;
    
    const row = document.createElement('tr');
    row.innerHTML = `
      <td style="font-weight:bold;color:var(--accent)">
        <a href="index.html?cve=${v.cve_id}" style="color:inherit;text-decoration:none;">${escapeHtml(v.cve_id)}</a>
      </td>
      <td><span class="badge ${v.status === 'active' ? 'bg-bad' : 'bg-ok'}">${escapeHtml(v.status)}</span></td>
      <td>${cvssCurrent ?? "‚Äî"}</td>
      <td>${epssCurrent ? (epssCurrent*100).toFixed(2) + "%" : "‚Äî"}</td>
      <td><span class="badge ${kevCurrent ? 'bg-bad' : ''}">${kevCurrent ? "OUI" : "Non"}</span></td>
      <td>${isRemoteExploitable(v) ? '<span class="badge bg-warn">OUI</span>' : 'Non'}</td>
      <td><small>${escapeHtml(v.affected_components?.join(", ") || "‚Äî")}</small></td>
      <td class="sources"><small>${renderSources(v.publications)}</small></td>
      <td><small>${safeDateLabel(v?.dates?.last_check, "datetime")}</small></td>
    `;
    body.appendChild(row);
  });
}

// Logique de tri
document.querySelectorAll("th[data-key]").forEach(th => {
  th.addEventListener("click", () => {
    const key = th.dataset.key;
    sortDir = (sortKey === key && sortDir === "asc") ? "desc" : "asc";
    sortKey = key;
    document.querySelectorAll("th").forEach(t => t.classList.remove("sort-asc","sort-desc"));
    th.classList.add(sortDir === "asc" ? "sort-asc" : "sort-desc");
    renderTable(applySort(dataCache));
  });
});

function applySort(list) {
  if (!sortKey) return list;
  return [...list].sort((a, b) => {
    let va = a[sortKey], vb = b[sortKey]; // Simplification pour l'exemple
    if (va < vb) return sortDir === "asc" ? -1 : 1;
    if (va > vb) return sortDir === "asc" ? 1 : -1;
    return 0;
  });
}

refreshData();
</script>
</body>
</html>
