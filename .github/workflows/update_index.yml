import json
import os
import sys

def generate_mitre_index():
    # Définition des chemins
    base_dir = os.getcwd()
    matrices_dir = os.path.join(base_dir, "matrices")
    build_dir = os.path.join(base_dir, "build")
    
    matrices = {
        "enterprise": "enterprise.json",
        "mobile": "mobile.json",
        "ics": "ics.json"
    }
    
    print(f"--- Diagnostic ---")
    print(f"Dossier courant : {base_dir}")
    if os.path.exists(matrices_dir):
        print(f"Contenu de /matrices : {os.listdir(matrices_dir)}")
    else:
        print(f"❌ ERREUR : Le dossier /matrices n'existe pas à la racine.")
        sys.exit(2)

    master_index = {}

    # Créer le dossier build
    if not os.path.exists(build_dir):
        os.makedirs(build_dir)

    for name, filename in matrices.items():
        path = os.path.join(matrices_dir, filename)
        
        if not os.path.exists(path):
            print(f"⚠️  Fichier manquant : {filename}. Vérifiez la casse !")
            continue
            
        print(f"Traitement de {filename}...")
        try:
            with open(path, 'r', encoding='utf-8') as f:
                data = json.load(f)
                for obj in data.get('objects', []):
                    if obj.get('type') == 'attack-pattern' and not obj.get('x_mitre_deprecated'):
                        tid = next((ref.get('external_id') for ref in obj.get('external_references', []) 
                                  if ref.get('source_name') == 'mitre-attack'), None)
                        if tid:
                            if tid in master_index:
                                if name not in master_index[tid]['m']:
                                    master_index[tid]['m'].append(name)
                            else:
                                master_index[tid] = {
                                    "n": obj.get('name'),
                                    "m": [name],
                                    "t": [p.get('phase_name') for p in obj.get('kill_chain_phases', [])]
                                }
        except Exception as e:
            print(f"❌ Erreur lors de la lecture de {filename} : {e}")

    # Sauvegarde
    output = os.path.join(build_dir, "mitre_map_index.json")
    with open(output, 'w', encoding='utf-8') as f:
        json.dump(master_index, f, separators=(',', ':'))
    
    print(f"--- Fin ---")
    print(f"Index généré avec succès dans {output}")

if __name__ == "__main__":
    generate_mitre_index()
