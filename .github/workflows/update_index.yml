import json
import os

def generate_mitre_index():
    # Chemins relatifs à la racine du dépôt
    matrices = {
        "enterprise": "matrices/enterprise.json",
        "mobile": "matrices/mobile.json",
        "ics": "matrices/ics.json"
    }
    
    master_index = {}
    print(f"Répertoire de travail actuel : {os.getcwd()}")

    # Créer le dossier build s'il n'existe pas
    if not os.path.exists('build'):
        os.makedirs('build')
        print("Dossier 'build' créé.")

    for matrix_name, file_path in matrices.items():
        if not os.path.exists(file_path):
            print(f"❌ ERREUR : Le fichier {file_path} est introuvable.")
            continue
            
        print(f"Lecture de {matrix_name}...")
        with open(file_path, 'r', encoding='utf-8') as f:
            data = json.load(f)
            
        count = 0
        for obj in data.get('objects', []):
            if obj.get('type') == 'attack-pattern' and not obj.get('x_mitre_deprecated'):
                tid = None
                for ref in obj.get('external_references', []):
                    if ref.get('source_name') == 'mitre-attack':
                        tid = ref.get('external_id')
                        break
                
                if tid:
                    if tid in master_index:
                        if matrix_name not in master_index[tid]['m']:
                            master_index[tid]['m'].append(matrix_name)
                    else:
                        master_index[tid] = {
                            "n": obj.get('name'),
                            "m": [matrix_name],
                            "t": [p.get('phase_name') for p in obj.get('kill_chain_phases', [])]
                        }
                    count += 1
        print(f"✅ {matrix_name} : {count} techniques.")

    # Sauvegarde
    output_path = 'build/mitre_map_index.json'
    with open(output_path, 'w', encoding='utf-8') as f:
        json.dump(master_index, f, separators=(',', ':'))
    
    print(f"\nSuccès ! Index généré dans {output_path}")

if __name__ == "__main__":
    generate_mitre_index()
